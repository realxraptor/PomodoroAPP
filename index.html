<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pomocoin</title>
   <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffeb3b" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
/* Responsive To Do List Activity Card */
.activity {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  background: var(--activity-bg, #f8f8f8);
  border-radius: 0.6em;
  margin: 1em 0;
  padding: 1em 1.5em;
  font-size: 1.2em;
  box-shadow: 0 0.08em 0.4em rgba(0,0,0,0.07);
  color: var(--activity-text, #222);
  word-break: break-word;
}
.activity span {
  font-weight: bold;
  font-size: 1em;
}
.activity .activityCompleteBtn {
  font-size: 0.95em;
  margin-left: 0.5em;
  padding: 0.5em 1em;
}
.activity .goalBtn {
  font-size: 1em;
  margin-left: 0.5em;
  padding: 0.5em 1em;
}
.coin-icon {
  height: 1em;
  width: auto;
  vertical-align: middle;
  margin-left: 4px;
}
/* Settings sliders */
.switch {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  font-size: 1em;
  margin: 12px 0;
}

.switch input {
  display: none;
}

.slider {
  width: 40px;
  height: 20px;
  background-color: #ccc;
  border-radius: 20px;
  position: relative;
  cursor: pointer;
  transition: background-color 0.3s;
}

.slider::before {
  content: "";
  position: absolute;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: white;
  top: 1px;
  left: 1px;
  transition: transform 0.3s;
}

input:checked + .slider {
  background-color: #2ecc71;
}

input:checked + .slider::before {
  transform: translateX(20px);
}

.label-text {
  user-select: none;
}
/* Media responsive */

@media (max-width: 768px) {
  .activity {
    padding: 0.7em 1em;
    font-size: 1em;
  }
  .activity span {
    font-size: 0.95em;
  }
  .activity .activityCompleteBtn,
  .activity .goalBtn {
    font-size: 0.9em;
    padding: 0.4em 0.7em;
  }
}
@media (max-width: 480px) {
  .activity {
    flex-direction: column;
    align-items: stretch;
    padding: 0.5em 0.5em;
    font-size: 0.95em;
  }
  .activity span {
    font-size: 0.9em;
    margin-bottom: 0.5em;
  }
  .activity .activityCompleteBtn,
  .activity .goalBtn {
    font-size: 0.85em;
    margin-left: 0;
    margin-top: 0.5em;
    padding: 0.35em 0.6em;
    width: 100%;
    box-sizing: border-box;
  }
}
/* Responsive Set Goal button */
.goalBtn {
  font-size: 1em;
  padding: 0.7em 1.5em;
  max-width: 100%;
  margin-left: 24px;
  border-radius: 4px;
  box-sizing: border-box;
}
@media (max-width: 480px) {
  .goalBtn {
    font-size: 0.95em;
    padding: 0.5em 0.7em;
    margin-left: 8px;
  }
}



/* --- Responsive Layout & Flexbox --- */
body {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap; /* Allow wrapping for side panel */
  justify-content: center;
  align-items: flex-start;
  gap: 2em; /* Use em for gap */
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 0;
  font-size: 1.1rem;
  transition: background 0.3s;
}
.container {
  max-width: 1500px;
  width: 100%;
  margin: 2.5em auto;
  background: #fff;
  padding: 2em;
  border-radius: 0.5em;
  box-shadow: 0 0.125em 0.5em rgba(0,0,0,0.1);
  box-sizing: border-box;
  flex: 1 1 22em;
}
.responsive-image {
  width: 100%;        /* container kadar genişle */
  max-width: 75px;   /* ama en fazla 500px */
  min-width: 50px;   /* en az 150px */
  height: auto;       /* oranı koru */
  display: block;
  margin: 0 auto;     /* ortala */
  border-radius: 12px; /* istersen köşe yumuşatma */
}

h1 {
  text-align: center;
  color: #d35400;
  font-size: 2.2em;
}
.coins {
  font-size: 1.3em;
  margin-bottom: 1em;
  text-align: center;
}
.timer {
  font-size: 2.5em;
  text-align: center;
  margin: 1.5em 0;
}
.controls {
  text-align: center;
  display: flex;
  flex-wrap: wrap;
  gap: 0.75em;
  justify-content: center;
}
button {
  background: #d35400;
  color: #fff;
  border: none;
  padding: 0.7em 1.5em;
  margin: 0 0.5em;
  border-radius: 0.25em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s;
  max-width: 100%;
  box-sizing: border-box;
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.5;
  transition: opacity 0.3s;
}
.tabBtn {
  background: #eee;
  color: #d35400;
  border: none;
  padding: 0.5em 1.5em;
  margin: 0.4em 0.25em 1em 0.4em;
  border-radius: 0.25em;
  font-size: 1em;
  cursor: pointer;
  max-width: 100%;
  
}
.tabBtn.active {
  background: #d35400;
  color: #fff;
}
.tabContent {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.themeBtn {
  margin: 0.5em;
  padding: 0.5em 1em;
  border-radius: 0.25em;
  border: none;
  cursor: pointer;
  font-size: 1em;
  max-width: 100%;
}

.themeBtn.selected { box-shadow: 0 0 8px #27ae60; }
#AppTitle {
  font-size: 2em;
  font-weight: bold;
  color: #333;
  text-align: center;
  margin-top: 0;
  margin-left: 0.6em;
}
#progressBarContainer {
  background: #eee;
  border-radius: 8px;
  height: 24px;
  position: relative;
  overflow: hidden;
  margin-top: 8px;
  width: 100%;
  max-width: 100%;
}
#progressBar {
  background: #d35400;
  height: 100%;
  width: 0%;
  border-radius: 8px;
  transition: width 0.3s;
}
#progressText {
  position: absolute;
  left: 50%;
  top: 0;
  transform: translateX(-50%);
  color: #222;
  font-weight: bold;
  line-height: 1.5em;
  font-size: 1em;
}
.settingsBtn {
  background: #d35400;
  color: #fff;
  border: none;
  padding: 0.7em 1.5em;
  border-radius: 0.25em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s, color 0.3s;
  max-width: 100%;
  box-sizing: border-box;
}
.settingsBtn:disabled {
  background: #ccc;
  color: #888;
  cursor: not-allowed;
}
/* Remove transform for responsive layout */
#sideApp, #mainApp {
  transform: none;
}

/* --- Custom Alert Responsive Positioning --- */
#customAlert {
  display: none;
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  transition: opacity 0.3s ease;
  background-color: #2ecc71;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 9999;
  max-width: 90vw;
  text-align: center;
  word-break: break-word;
}

/* --- Top Navigation Bar & Divider --- */
#topBar {
  width: 100vw;
  min-width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--theme-bg, #f4f4f4);
  padding: 0.5em 1em;
  box-sizing: border-box;
  position: sticky;
  top: 0;
  z-index: 100;
}
#logoPlaceholder {
  width: 48px;
  height: 48px;
  background: #eee;
  border-radius: 8px;
  margin-right: 1em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  color: #bbb;
}
#navTabs {
  display: flex;
  align-items: center;
  gap: 0.5em;
  flex: 1;
}
#navTitle {
  font-size: 1.3em;
  font-weight: bold;
  margin-right: 1.5em;
  color: var(--theme-title, #d35400);
  transition: color 0.3s;
}
@media (max-width: 768px) {
  body {
    font-size: 1rem;
  }
  h1 {
    font-size: 1.5em;
  }
  .timer {
    font-size: 2em;
  }
  .coins {
    font-size: 1em;
  }
  #AppTitle {
    font-size: 1.3em;
  }
  button, .settingsBtn, .tabBtn, .themeBtn {
    font-size: 0.95em;
    padding: 0.5em 1em;
  }
  #topBar {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 0.5em 0.5em;
  }
  #logoPlaceholder {
    margin: 0 auto 0.5em auto;
  }
  #navTabs {
    flex-direction: column;
    gap: 0.5em;
    align-items: flex-start;
  }
  #navTitle {
    margin-right: 0;
    margin-bottom: 0.5em;
  }
  #dividerLine {
    height: 36px;
  }
}
@media (max-width: 480px) {
  body {
    font-size: 0.9rem;
  }
  h1 {
    font-size: 1.1em;
  }
  .timer {
    font-size: 1.3em;
  }
  .coins {
    font-size: 0.95em;
  }
  #AppTitle {
    font-size: 1em;
  }
  button, .settingsBtn, .tabBtn, .themeBtn {
    font-size: 0.9em;
    padding: 0.4em 0.7em;
  }
  #topBar {
    padding: 0.25em 0.25em;
  }
  #logoPlaceholder {
    width: 36px;
    height: 36px;
    font-size: 1em;
  }
  #navTitle {
    font-size: 1em;
  }
  #dividerLine {
    height: 24px;
  }
}


/* --- End Responsive Layout --- */
    </style>
</head>
    <!-- Service Worker Registration for PWA -->
    <script>
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registration successful:', registration);

        // Güncelleme algılama event’i burada
        registration.addEventListener('updatefound', () => {
          const newSW = registration.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              // Yeni sürüm yüklendi, kullanıcıya bildir
              alert('A new version is available! Please refresh the page.');
            }
          });
        });

      })
      .catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}


    </script>
</body>
<div id="topBar">
   <img src="./images/icon1.png" alt="Pomocoin" class="responsive-image">



  <span id="AppTitle"> Pomocoin </span>

    <div id="navTabs">
        <button class="tabBtn active" id="pomodoroTabBtn">Pomodoro</button>
        <button class="tabBtn" id="shopTabBtn">Shop</button>
        <button class="tabBtn" id="settingsTabBtn">Settings</button>
        <button class="tabBtn" id="todoTabBtn">To Do List</button>
    </div>
</div>
<!-- Divider Line -->


<div class="container" id = "mainApp">
    <h1 id="mainTitle" style="display:none;"></h1>
    <div id="customAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #2ecc71; color: white; padding: 12px 24px; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 9999; transition: opacity 0.3s; max-width: 90vw; text-align: center; word-break: break-word;"></div>
        <div class="tabContents">
            <div id="pomodoroTab" class="tabContent" style="display:block;">
                <h2 id="CounterTitle" style="text-align:center; color:#0b0b0b;">Pomodoro</h2>
                <div class="coins">
            
                  <span id="coinCount">0</span>
                  <img src="./images/currencyimage.png" alt="Coin" class="coin-icon">  
                </div>


                <!-- Timer Mode Selector -->
                <div style="text-align:center; margin-bottom:16px;">
                    <label><input type="radio" name="timerMode" id="studyMode" value="study" checked> Study</label>
                    <label><input type="radio" name="timerMode" id="breakMode" value="break"> Break</label>
                    <label><input type="radio" name="timerMode" id="stopwatchMode" value="stopwatch"> Stopwatch</label>
                </div>
                <!-- Study Timer UI -->
                <div id="studyTimerUI">
                    <div style="text-align:center; margin-bottom:16px;">
                        <label for="pomodoroTime">Set Study Time (minutes): </label>
                        <input type="number" id="pomodoroTime" min="1" max="120" value="25" style="width:60px;">
                    </div>
                    <div class="timer" id="timer">25:00</div>
                    <div class="controls">
                        <button id="startBtn">Start</button>
                        <button id="pauseBtn" disabled>Pause</button>
                        <button id="resetBtn">Reset</button>
                    </div>
                    <p style="text-align:center; color:#888; margin-top:24px;">
                        Earn 1 coin for every minute you study!
                    </p>
                </div>
                <!-- Break Timer UI -->
                <div id="breakTimerUI" style="display:none;">
                    <div style="text-align:center; margin-bottom:16px;">
                        <label for="breakTime">Set Break Time (minutes): </label>
                        <input type="number" id="breakTime" min="1" max="60" value="5" style="width:60px;">
                    </div>
                    <div class="timer" id="breakTimer">05:00</div>
                    <div class="controls">
                        <button id="breakStartBtn">Start Break</button>
                        <button id="breakPauseBtn" disabled>Pause</button>
                        <button id="breakResetBtn">Reset</button>
                    </div>
                    <p style="text-align:center; color:#888; margin-top:24px;">
                        Break timer does not award coins.
                    </p>
                </div>
                <!-- Stopwatch UI -->
                <div id="stopwatchUI" style="display:none;">
                    <div class="timer" id="stopwatchTimer">00:00</div>
                    <div class="controls">
                        <button id="stopwatchStartBtn">Start</button>
                        <button id="stopwatchPauseBtn" disabled>Pause</button>
                        <button id="stopwatchResetBtn">Reset</button>
                    </div>
                    <p style="text-align:center; color:#888; margin-top:24px;">
                       Earn 1 coin for every minute you study!
                    </p>
                </div>
           
                <div style="text-align:center; margin:24px 0;" id="goalLabel">
                    <label for="goalLabel"> Goal: </label>
                </div>

                <div style="text-align:center; margin:24px 0;">
                    <div style="width:90%;margin:auto;">
                        <div id="progressBarContainer">
                            <div id="progressBar"></div>
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>
             
            </div>
            <div id="shopTab" class="tabContent" style="display:none;">
                          <h2 id="shopTitle" style="text-align:center; color:#d35400;">Shop</h2>
                <div class="coins">Coins: <span id="coinCountShop">0</span></div>
      
                <div id="themesShop" style="margin-bottom:24px;"></div>
                <h3 style="text-align:center; color:#888;">Inventory</h3>
                <div id="inventoryThemes" style="text-align:center;"></div>
                 
            </div>
            <div id="settingsTab" class="tabContent" style="display:none;">
                <h2 style="text-align:center;" id="settingsTitle">Settings</h2>
                        
                  <!-- Settings Mode-->
           <div style="text-align:center; margin-bottom:16px;">
  <button id="settingsPomodoroTabBtn" class="tabBtn active">Pomodoro</button>
  <button id="settingsDataTabBtn" class="tabBtn">Data</button>
</div>
                <!-- SettingTab POMODORO -->
                <div id="SettingTabPomodoro"> 
                   <div style="display: flex; align-items: center; margin: 24px 0;">
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
  <span style="padding: 0 12px; color: #888; font-weight: bold;">Pomodoro</span>
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
</div>

                <div style="text-align:center; margin:24px 0;">
                    <label for="goalInput">Set Goal (coins): </label>
                    <input type="number" id="goalInput" min="1" value="100" style="width:80px;">
                </div>
              
                      
  <label class="switch">
  <input type="checkbox" id="SettingOne">
  <span class="slider"></span>
  <span class="label-text">Pause the stopwatch when the goal is achieved.</span>
</label>

 <label class="switch">
  <input type="checkbox" id="AutoStartBreak">
  <span class="slider"></span>
  <span class="label-text">Auto start breaks.</span>
</label>

 <label class="switch">
  <input type="checkbox" id="AutoStartStudy">
  <span class="slider"></span>
  <span class="label-text">Auto start study.</span>
</label>




               
</div>
                   <!-- SettingTab DATA -->
<div id="SettingTabData">
                  
<div style="display: flex; align-items: center; margin: 24px 0;">
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
  <span style="padding: 0 12px; color: #888; font-weight: bold;">Auto Data Delete</span>
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
</div>

<div style="text-align:center; margin:24px 0;">
  <label class="switch">
    <input type="checkbox" id="autoDeleteEnable">
    <span class="slider"></span>
    <span class="label-text">Enable Auto Data Delete</span>
  </label>
</div>
<div style="text-align:center; margin:24px 0;">
  <label for="autoDeleteDay">Day:</label>
  <select id="autoDeleteDay" style="margin-right:12px;">
    <option value="0">Sunday</option>
    <option value="1">Monday</option>
    <option value="2">Tuesday</option>
    <option value="3">Wednesday</option>
    <option value="4">Thursday</option>
    <option value="5">Friday</option>
    <option value="6">Saturday</option>
  </select>
  <label for="autoDeleteHour">Hour:</label>
  <input type="number" id="autoDeleteHour" min="0" max="23" value="1" style="width:60px;">
  <label for="autoDeleteMinute">Minute:</label>
  <input type="number" id="autoDeleteMinute" min="0" max="59" value="0" style="width:60px;">

</div>
<div style="text-align:center; margin:24px 0;">
  <label for="autoDeleteType">Delete:</label>
  <select id="autoDeleteType" style="margin-left:12px;">
    <option value="coins">Coins Only</option>
    <option value="inventory">Inventory Only</option>
    <option value="both">Coins & Inventory</option>
  </select>
</div>
<div style="text-align:center; margin:12px 0;">
  <span id="autoDeleteCountdown" style="color:#888; font-size:1.1em;">Next auto delete in: --</span>
</div>
<div style="display: flex; align-items: center; margin: 24px 0;">
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
  <span style="padding: 0 12px; color: #888; font-weight: bold;">Manage Data</span>
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
</div>

<div style="text-align:center; margin:24px 0;">
                    <label for="manualDeleteType" style="margin-right:8px;">Delete:</label>
                    <select id="manualDeleteType" style="margin-right:12px;">
                      <option value="coins">Coins Only</option>
                      <option value="inventory">Inventory Only</option>
                      <option value="both">Coins & Inventory</option>
                    </select>
                    <button id="deleteDataBtn" class="settingsBtn">Confirm</button>
</div>

<div style="text-align:center; margin:24px 0;">
                    <label for="changeDataType" style="margin-right:8px;">Change:</label>
                    <select id="changeDataType" style="margin-right:12px;">
                      <option value="coins">Coins</option>
                      <option value="crystal">Crystal</option>
                    </select>
                    <input type="number" id="changedata" style="width:120px; margin-right:12px;">
                    <button id="changeDataBtn" class="settingsBtn">Confirm</button>
</div>
<!-- PIN Setting -->
 <div style="display: flex; align-items: center; margin: 24px 0;">
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
  <span style="padding: 0 12px; color: #888; font-weight: bold;">PIN</span>
  <div style="flex: 1; height: 1px; background-color: #ccc;"></div>
</div>


<div style="text-align:center; margin:24px 0;">
  <label for="pinSettingInput">Set/Change PIN:</label>
  <input type="password" id="pinSettingInput" style="width:120px; margin-right:12px;">
  <button id="setPinBtn" class="settingsBtn">Save PIN</button>
  <button id="clearPinBtn" class="settingsBtn" style="background:#ccc; color:#222;">Clear PIN</button>
  <div id="pinSettingMsg" style="color:#888; margin-top:8px;"></div>
</div>



                </div>

</div>


             


                
        </div>
            <!-- New To Do List Tab -->
            <div id="todoTab" class="tabContent" style="display:none;">
                <h2 style="text-align:center;">To Do List</h2>
                <div class="coins">Coins: <span id="coinCountTDL">0</span></div>
                <div id="todoListContainer" style="max-width:600px; margin:32px auto; background:#f8f8f8; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:32px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <span id="completionEstimate" style="color:#888; font-size:1.1em;">Estimated finish time: --:--</span>
                        <button id="addActivityBtn" class="settingsBtn" style="font-size:1.1em; padding:12px 32px;">Add Activity</button>
                    </div>
                    <div id="activityList"></div>
                </div>
              
            </div>


        </div>
</div>



  <!-- Pomodoro -->
<div id="activityModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:300px; max-width:90vw; margin:auto;">
        <h3 style="margin-top:0;">Add Activity</h3>
        <label>Activity Name:</label>
        <input type="text" id="activityNameInput" style="width:100%; margin-bottom:12px;">
        <label>Coin Price:</label>
        <input type="number" id="activityPriceInput" min="1" value="10" style="width:100%; margin-bottom:12px;">
        <div style="text-align:right;">
            <button id="confirmActivityBtn" class="settingsBtn">Confirm</button>
            <button id="cancelActivityBtn" class="settingsBtn" style="background:#ccc; color:#222;">Cancel</button>
        </div>
    </div>
</div>
<!-- PIN -->
<div id="pinModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:300px; max-width:90vw; margin:auto; text-align:center;">
    <h3>Enter PIN</h3>
    <input type="password" id="pinInput" style="width:80%; margin-bottom:16px;">
    <div>
      <button id="pinConfirmBtn" class="settingsBtn">Confirm</button>
      <button id="pinCancelBtn" class="settingsBtn" style="background:#ccc; color:#222;">Cancel</button>
    </div>
    <div id="pinError" style="color:#e74c3c; margin-top:12px; display:none;">Incorrect PIN.</div>
  </div>
</div>


    <script>


// --- Main JavaScript Logic ---


       


        // Pomodoro logic - Three Timer Modes
        let timer = 25 * 60;
        let interval = null;
        let coins = 0; // coin balance is loaded from localStorage
        let lastMinute = 25;
        let pomodoroDuration = 25;
        // Break timer
        let breakTimer = 5 * 60;
        let breakInterval = null;
        let breakDuration = 5;
        // Stopwatch
        let stopwatchSeconds = 0;
        let stopwatchInterval = null;
        let stopwatchRunning = false;

        // --- Get password protected settings ---
function getPIN() {
    const savedPIN = localStorage.getItem('pomodoroPIN');
    if (!savedPIN) {
        // No PIN set, allow access
        return true;
    }
    // Ask user for PIN using browser prompt
    const enteredPIN = prompt("Enter your PIN:");
    if (enteredPIN === savedPIN) {
        return true;
    } else {
        alert("Incorrect PIN!");
        return false;
    }
}
function updateClearPinBtnState() {
    const hasPin = !!localStorage.getItem('pomodoroPIN');
    document.getElementById('clearPinBtn').disabled = !hasPin;
    document.getElementById('setPinBtn').disabled = hasPin;
}


// Run on page load
updateClearPinBtnState();
        // --- Persistent Coin Logic ---
        // Save/load coins and last reset date from localStorage
function getTodayString() {
    // Returns YYYY-MM-DD for local time
    const now = new Date();
    return now.getFullYear() + '-' + (now.getMonth()+1).toString().padStart(2,'0') + '-' + now.getDate().toString().padStart(2,'0');
}



function getCurrentHour() {
            return new Date().getHours();
}

function loadCoins() {
    const saved = localStorage.getItem('pomodoroCoins');

        coins = saved ? parseInt(saved) : 0;
    updateCoinsDisplay();
}

        function saveCoins() {
            localStorage.setItem('pomodoroCoins', coins);
        }

        function addCoins(amount) {
            coins += amount;
            saveCoins();
            updateCoinsDisplay();
            updateProgressBar();
        }

        function subtractCoins(amount) {
            coins = Math.max(0, coins - amount);
            saveCoins();
            updateCoinsDisplay();
        }



        // --- End Persistent Coin Logic ---

        // Custom Alert
let customAlertTimeout = null;
function showCustomAlert(message, type = 'success', duration = 3000) {
    const alertBox = document.getElementById('customAlert');
    if (!alertBox) {
        console.warn('Custom alert element not found.');
        
        return;
    }
    // Clear previous timeout if alert is already showing
    if (customAlertTimeout) {
        clearTimeout(customAlertTimeout);
        customAlertTimeout = null;
    }
    alertBox.textContent = message;

    // Renkleri belirle
    let bgColor = '#2ecc71'; // success
    if (type === 'error') bgColor = '#e74c3c';
    if (type === 'info') bgColor = '#3498db';

    alertBox.style.backgroundColor = bgColor;
        alertBox.style.opacity = '1';
    alertBox.style.display = 'block';


    customAlertTimeout = setTimeout(() => {
        alertBox.style.opacity = '0';
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 300);
        customAlertTimeout = null;
    }, duration);
}


        // Theme shop logic
         const themes = [
            { name: "Classic", bundle: "Starter",price: 0, bg: "#f4f4f4", btn: "#fff9dc",Tb: "#e6e6e6", text: "#222",},
            { name: "Night", bundle: "Starter", price: 0, bg: "#222", btn: "#34495e",Tb: "#4f4f4f ", text: "#fff" ,},
           

            { name: "Monochrome", bundle: "Basic", price: 30, bg: "#f4f4f4", btn: "#f4f4f4",Tb: "#4f4f4f", text: "#222" ,},
            { name: "Coffee",bundle: "Basic", price: 30, bg: "#ffd9b6", btn: "#c09062 ",Tb: "#f0b883", text: "#222" ,},


{ name: "Forest",bundle: "Botanica", price: 45, bg: "#e8f5e9", btn: "#4caf50",Tb: "#c8e6c9", text: "#222" ,},
{ name: "Mint", bundle: "Botanica",price: 45, bg: "#e8f8f5", btn: "#16a085",Tb: "#aedaa0", text: "#222", },
{ name: "Lavender",bundle: "Botanica", price: 45, bg: "#f3e5f5", btn: "#9c27b0",Tb: "#d1c4e9", text: "#222" ,},
 { name: "Rose",bundle: "Botanica", price: 45, bg: "#fff0f5", btn: "#e84393",Tb: "#dcbcd4", text: "#222" ,},
 { name: "Slate", bundle: "Botanica",price: 45, bg: "#eceff1", btn: "#607d8b",Tb: "#cfd8dc", text: "#222" ,},       
             
            { name: "Ocean",bundle: "Skynature", price: 60, bg: "#e0f7fa", btn: "#00bcd4",Tb: "#b2ebf2", text: "#222" ,},
            { name: "Sunset",bundle: "Skynature", price: 60, bg: "#fff3e0", btn: "#ff9800",Tb: "#ffe0b2", text: "#222" ,},
            { name: "Twilight", bundle: "Skynature",price: 60, bg: "#fce4ec", btn: "#e91e63",Tb: "#f8bbd0", text: "#222" ,},


  { name: "Lemon", bundle: "Fruit",price: 75, bg: "#fffde7", btn: "#ffeb3b",Tb: "#fff9c4", text: "#222" ,},
  { name: "Pineapple", bundle: "Fruit",price: 75, bg: "#fffde7", btn: "#f0e310",Tb: "#bdf17f", text: "#222" ,},
    { name: "Melon",bundle: "Fruit", price: 75, bg: "#ff9b89", btn: "#6dc053",Tb: "#de7c72", text: "#222" ,},
  { name: "Tomato", bundle: "Fruit",price: 75, bg: "#ffebee", btn: "#f44336",Tb: "#ffcdd2", text: "#222" ,},
       { name: "Grapes", bundle: "Fruit",price: 75, bg: "#bf9ae0", btn: "#763ef7",Tb: "#b886c2", text: "#222" ,},  
  
    
          
         
             
           

           
         { name: "Copper",bundle: "Royal Metals", price: 120, bg: "#ffccbc", btn: "#ff7043",Tb: "#ffab91", text: "#222" ,},
            { name: "Platinum", bundle: "Royal Metals",price: 120, bg: "#e0e0e0", btn: "#b0bec5",Tb: "#cfd8dc", text: "#222" ,},
                { name: "Bronze",bundle: "Royal Metals", price: 120, bg: "#f4f4f4", btn: "#cd7f32",Tb: "#d2b48c", text: "#222" ,},
              { name: "Silver",bundle: "Royal Metals", price: 120, bg: "#f5f5f5", btn: "#9e9e9e",Tb: "#bdbdbd", text: "#222" ,},
            { name: "Golden",bundle: "Royal Metals", price: 120, bg: "#ebd8aa", btn: "#FFC300",Tb: "#d9bf68", text: "#222" ,},


            
            {name: "Sapphire", bundle: "Gemstone", price: 180, bg: "#e3f2fd", btn: "#2196f3",Tb: "#bbdefb", text: "#222" ,},
            { name: "Amethyst", bundle: "Gemstone", price: 180, bg: "#E6D6F3", btn: "#6A4C93",Tb: "#B088CC", text: "#222" ,},
          { name: "Diamond", bundle: "Gemstone",price: 180, bg: "#F0F8FF", btn: "#8DA9C4",Tb: "#C8D8E4", text: "#222" ,},
          
           

    

           
           

          
          
            
           
          
             




        ];
        let ownedThemes = ["Night", "Classic"]; // Default owned themes
        let selectedTheme = "Classic";
        let goal = 100;

        function updateTimerDisplay() {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            document.getElementById('timer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            localStorage.setItem('pomodoroTimer', timer);
            console.log("Timer saved to localStorage:", timer);
        }
        function updateBreakTimerDisplay() {
            const minutes = Math.floor(breakTimer / 60);
            const seconds = breakTimer % 60;
            document.getElementById('breakTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
   
            localStorage.setItem('breakTimer', breakTimer);
        }
        function updateStopwatchDisplay() {
            const minutes = Math.floor(stopwatchSeconds / 60);
            const seconds = stopwatchSeconds % 60;
            document.getElementById('stopwatchTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
             localStorage.setItem('swTimer', stopwatchSeconds);
        }
        function updateProgressBar() {
            let percent = Math.min(100, Math.floor((coins / goal) * 100));
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }
        function updateCoinsDisplay() {
            document.getElementById('coinCount').textContent = coins;
            if (!document.getElementById('coinCount').nextElementSibling || !document.getElementById('coinCount').nextElementSibling.classList.contains('coin-icon')) {
                const coinImg = document.createElement('img');
                coinImg.src = './images/currencyimage.png';
                coinImg.alt = 'Coin';
                coinImg.className = 'coin-icon';
                document.getElementById('coinCount').after(coinImg);
            }
            document.getElementById('coinCountShop').textContent = coins;
            if (!document.getElementById('coinCountShop').nextElementSibling || !document.getElementById('coinCountShop').nextElementSibling.classList.contains('coin-icon')) {
                const coinImg = document.createElement('img');
                coinImg.src = './images/currencyimage.png';
                coinImg.alt = 'Coin';
                coinImg.className = 'coin-icon';
                document.getElementById('coinCountShop').after(coinImg);
            }
            document.getElementById('coinCountTDL').textContent = coins;
            if (!document.getElementById('coinCountTDL').nextElementSibling || !document.getElementById('coinCountTDL').nextElementSibling.classList.contains('coin-icon')) {
                const coinImg = document.createElement('img');
                coinImg.src = './images/currencyimage.png';
                coinImg.alt = 'Coin';
                coinImg.className = 'coin-icon';
                document.getElementById('coinCountTDL').after(coinImg);
            }
        }

        // --- Timer Mode Logic ---
        function showTimerMode(mode) {
            document.getElementById('studyTimerUI').style.display = (mode === 'study') ? 'block' : 'none';
            document.getElementById('breakTimerUI').style.display = (mode === 'break') ? 'block' : 'none';
            document.getElementById('stopwatchUI').style.display = (mode === 'stopwatch') ? 'block' : 'none';
        }
        function setTimerModeDisabled(disabled) {
            document.getElementById('studyMode').disabled = disabled;
            document.getElementById('breakMode').disabled = disabled;
            document.getElementById('stopwatchMode').disabled = disabled;
        }
        function getSelectedTimerMode() {
            if (document.getElementById('studyMode').checked) return 'study';
            if (document.getElementById('breakMode').checked) return 'break';
            if (document.getElementById('stopwatchMode').checked) return 'stopwatch';
            return 'study';
        }
        // --- Study Timer ---
        function startTimer() {
          
             let IfSuccess = getPIN();
             if (!IfSuccess) return;


            if (interval) return;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            setTimerModeDisabled(true);
            interval = setInterval(() => {
                if (timer > 0) {
                    timer--;
                    const currentMinute = Math.floor(timer / 60);
                    if (timer % 60 === 0) {
                        addCoins(1);
                        lastMinute = currentMinute;
                    }
                    updateTimerDisplay();
                    calculateCompletionTimeEstimate();
                } else {          
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                    // Auto-switch to break mode if AutoStartBreak is enabled
                    if (document.getElementById('AutoStartBreak')?.checked) {
                        clearInterval(interval);
                        interval = null;
                        document.getElementById('breakMode').checked = true;
                        showTimerMode('break');
                        resetBreakTimer();
                        startBreakTimer();          
                        showCustomAlert("Study session complete! Time for a break.", "info");
                    } else {
                        
                        pauseTimer();
                    }
                }
            }, 1000);
        }
        function pauseTimer() {
            if (interval) {
                clearInterval(interval);
                interval = null;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                setTimerModeDisabled(false);
            }
        }
        function resetTimer() {
            pauseTimer();
            pomodoroDuration = parseInt(document.getElementById('pomodoroTime').value) || 25;
            timer = pomodoroDuration * 60;
            lastMinute = pomodoroDuration;
            document.getElementById('pauseBtn').disabled = true;
            updateTimerDisplay();
        }
        // --- Break Timer ---
        function startBreakTimer() {
            if (breakInterval) return;
            document.getElementById('breakStartBtn').disabled = true;
            document.getElementById('breakPauseBtn').disabled = false;
            setTimerModeDisabled(true);
            breakInterval = setInterval(() => {
                if (breakTimer > 0) {
                    breakTimer--;
                    updateBreakTimerDisplay();
                } else {
                   
                    document.getElementById('breakStartBtn').disabled = false;
                    document.getElementById('breakPauseBtn').disabled = true;
                    // Auto-switch to study mode if AutoStartStudy is enabled
                     if (document.getElementById('AutoStartStudy')?.checked) {
                        clearInterval(breakInterval);
                        breakInterval = null;
                        document.getElementById('studyMode').checked = true;
                        showTimerMode('study');
                        resetTimer();
                        startTimer();         
                        showCustomAlert("Break session complete! Study time!", "info");
                    } else {
                      pauseBreakTimer();
                    

                    }
                }
            }, 1000);
        }
        function pauseBreakTimer() {
            if (breakInterval) {
                clearInterval(breakInterval);
                breakInterval = null;
                document.getElementById('breakStartBtn').disabled = false;
                document.getElementById('breakPauseBtn').disabled = true;
                setTimerModeDisabled(false);
            }
        }
        function resetBreakTimer() {
            pauseBreakTimer();
            breakDuration = parseInt(document.getElementById('breakTime').value) || 5;
            breakTimer = breakDuration * 60;
            document.getElementById('breakPauseBtn').disabled = true;
            updateBreakTimerDisplay();
        }
        // --- Stopwatch Timer ---
        function startStopwatch() {

          if (document.getElementById('SettingOne')?.checked && coins >= goal) {

      
              showCustomAlert("The goal is already achieved. Stopwatch paused automatically. Increase your goal or disable auto-pause in settings.", "error");
       
              return;
           
          }
           


            stopwatchRunning = true;
            document.getElementById('stopwatchStartBtn').disabled = true;
            document.getElementById('stopwatchPauseBtn').disabled = false;
            setTimerModeDisabled(true);

            stopwatchInterval = setInterval(() => {
                if (document.getElementById('SettingOne')?.checked && coins >= goal) {
                    pauseStopwatch();

                    setTimeout(() => {
                        showCustomAlert("Goal reached! Stopwatch paused.", "success");
                    }, 10);
                    return;
                }

                stopwatchSeconds++;
                updateStopwatchDisplay();
                if (stopwatchSeconds % 60 === 0) {
                    addCoins(1);
                }
            }, 1000);
        }
        function pauseStopwatch() {
            if (stopwatchInterval) {
                clearInterval(stopwatchInterval);
                stopwatchInterval = null;
                stopwatchRunning = false;
                document.getElementById('stopwatchStartBtn').disabled = false;
                document.getElementById('stopwatchPauseBtn').disabled = true;
                setTimerModeDisabled(false);
            }
        }
        function resetStopwatch() {


            pauseStopwatch();
            stopwatchSeconds = 0;
            updateStopwatchDisplay();
            document.getElementById('stopwatchPauseBtn').disabled = true;
        }
        // --- PIN Logic ---
        document.getElementById('setPinBtn').onclick = function() {
         
    const pinInput = document.getElementById('pinSettingInput').value.trim();
    const msg = document.getElementById('pinSettingMsg');
    if (!pinInput) {
        msg.textContent = "Please enter a PIN.";
        msg.style.color = "#e74c3c";
           setTimeout(function() {
     msg.textContent = "";
        }, 1000); // 1000ms = 2 saniye
        return;
    }
    localStorage.setItem('pomodoroPIN', pinInput);
    msg.textContent = "PIN saved!";
    msg.style.color = "#2ecc71";
    document.getElementById('pinSettingInput').value = "";
         setTimeout(function() {
     msg.textContent = "";
        }, 1000); // 1000ms = 2 saniye
     updateClearPinBtnState();
};

        document.getElementById('clearPinBtn').onclick = function() {
   const pinInput = document.getElementById('pinSettingInput').value.trim();
       const msg = document.getElementById('pinSettingMsg');
 const savedPIN = localStorage.getItem('pomodoroPIN');
 if (!pinInput )  {
    msg.textContent = "Please enter a PIN.";
        msg.style.color = "#e74c3c";
         setTimeout(function() {
     msg.textContent = "";
        }, 1000); // 1000ms = 2 saniye
        return;
 }
  if (pinInput !== savedPIN) {
        msg.textContent = "Incorrect PIN.";
        msg.style.color = "#e74c3c";
         setTimeout(function() {
     msg.textContent = "";
        }, 1000); // 1000ms = 2 saniye
        return;
  }


    localStorage.removeItem('pomodoroPIN');
    document.getElementById('pinSettingMsg').textContent = "PIN cleared!";
    document.getElementById('pinSettingMsg').style.color = "#3498db";
    document.getElementById('pinSettingInput').value = "";
         setTimeout(function() {
     msg.textContent = "";
        }, 1000); // 1000ms = 2 saniye
       updateClearPinBtnState();
};

        // --- Event Listeners for Timer Modes ---
        document.getElementById('studyMode').addEventListener('change', function() {
            showTimerMode('study');
        });
        document.getElementById('breakMode').addEventListener('change', function() {
            showTimerMode('break');
        });
        document.getElementById('stopwatchMode').addEventListener('change', function() {
            showTimerMode('stopwatch');
        });
        // Study Timer buttons
        document.getElementById('startBtn').addEventListener('click', startTimer);
        document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
        document.getElementById('resetBtn').addEventListener('click', resetTimer);
         document.getElementById('pomodoroTime').addEventListener('change', function() {
           localStorage.setItem('pomodoroDuration', this.value);
            resetTimer();
        });
        // Load saved pomodoro duration from localStorage
        const savedPomodoroDuration = localStorage.getItem('pomodoroDuration');
        if (savedPomodoroDuration) {
            document.getElementById('pomodoroTime').value = savedPomodoroDuration;
            pomodoroDuration = parseInt(savedPomodoroDuration);
            lastMinute = pomodoroDuration;

          
        }
        if (localStorage.getItem('pomodoroTimer')) {
            timer = parseInt(localStorage.getItem('pomodoroTimer'));
            console.log("Loaded timer from localStorage:", timer);
             updateTimerDisplay();
         } else {
            timer = pomodoroDuration * 60;
             updateTimerDisplay();
         }
           
        // Break Timer buttons
        document.getElementById('breakStartBtn').addEventListener('click', startBreakTimer);
        document.getElementById('breakPauseBtn').addEventListener('click', pauseBreakTimer);
        document.getElementById('breakResetBtn').addEventListener('click', resetBreakTimer);
        document.getElementById('breakTime').addEventListener('change', function() {
              localStorage.setItem('breakDuration', this.value);
            resetBreakTimer();
        });
        // Load saved break duration from localStorage
        const savedBreakDuration = localStorage.getItem('breakDuration');
        if (savedBreakDuration) {
            document.getElementById('breakTime').value = savedBreakDuration;
            breakDuration = parseInt(savedBreakDuration);
     
          
        }
        if (localStorage.getItem('breakTimer')) {
            breakTimer = parseInt(localStorage.getItem('breakTimer'));
            console.log("Loaded breakTimer from localStorage:", breakTimer);
           updateBreakTimerDisplay()
           } else {
            breakTimer = breakDuration * 60;
           updateBreakTimerDisplay()
        }
          

        // Stopwatch buttons
        document.getElementById('stopwatchStartBtn').addEventListener('click', startStopwatch);
        document.getElementById('stopwatchPauseBtn').addEventListener('click', pauseStopwatch);
        document.getElementById('stopwatchResetBtn').addEventListener('click', resetStopwatch);
        // Load saved stopwatch seconds from localStorage
        const savedStopwatchSeconds = localStorage.getItem('swTimer');
        if (savedStopwatchSeconds) {
            stopwatchSeconds = parseInt(savedStopwatchSeconds);
            console.log("Loaded stopwatch seconds from localStorage:", stopwatchSeconds);
            updateStopwatchDisplay();
        } else {
            stopwatchSeconds = 0; // Default to 0 if not found
            updateStopwatchDisplay();
        }
             // Update completion estimate on activity list change

// Removed buggy calculateCompletionTimeEstimate function.
// The correct function for completion estimate is implemented for each day in the To Do List logic below.
   
        // Tab logic
       
        document.getElementById('pomodoroTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'block';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
          
        });
        document.getElementById('shopTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'block';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
         
        });
        document.getElementById('settingsTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'block';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
           
        });
        document.getElementById('todoTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'block';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
          
        });
        //Settings tab
  document.getElementById('settingsPomodoroTabBtn').onclick = function() {
  document.getElementById('SettingTabPomodoro').style.display = 'block';
  document.getElementById('SettingTabData').style.display = 'none';
  this.classList.add('active');
  document.getElementById('settingsDataTabBtn').classList.remove('active');
};
  document.getElementById('settingsDataTabBtn').onclick = function() {

let IfSuccess = getPIN();
if (!IfSuccess) return;

  document.getElementById('SettingTabPomodoro').style.display = 'none';
  document.getElementById('SettingTabData').style.display = 'block';
  this.classList.add('active');
  document.getElementById('settingsPomodoroTabBtn').classList.remove('active');
}; 

        // Shop logic
        function renderShop() {
            const shopDiv = document.getElementById('themesShop');
            shopDiv.innerHTML = '';
            // Group themes by bundle
            const bundleMap = {};
            themes.forEach (theme => {
                if (!ownedThemes.includes(theme.name)) {
                    const bundle = theme.bundle || 'Other';
                    if (!bundleMap[bundle]) bundleMap[bundle] = [];
                    bundleMap[bundle].push(theme);
                }
            });
            shopDiv.innerHTML = '';
            const bundleNames = Object.keys(bundleMap);
            if (bundleNames.length === 0) {
                shopDiv.innerHTML = '<p style="text-align:center; color:#888;">All themes owned!</p>';
                return;
            }
            // Create columns for each bundle
            const bundlesRow = document.createElement('div');
            bundlesRow.style.display = 'flex';
            bundlesRow.style.flexWrap = 'wrap';
            bundlesRow.style.gap = '24px';
            bundleNames.forEach(bundle => {
                const col = document.createElement('div');
                col.style.display = 'flex';
                col.style.flexDirection = 'column';
                col.style.alignItems = 'center';
                col.style.minWidth = '180px';
                col.style.marginBottom = '16px';
                // Use first theme's text color for bundle label
                const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
                const firstTheme = bundleMap[bundle][0];
                const bundleLabel = document.createElement('div');
                bundleLabel.textContent = bundle;
                bundleLabel.className = 'bundle-label';
                bundleLabel.style.color = themeObj.text;
                bundleLabel.style.fontWeight = 'bold';
                bundleLabel.style.fontSize = '1.1em';
                bundleLabel.style.marginBottom = '8px';
                col.appendChild(bundleLabel);
                bundleMap[bundle].forEach(theme => {
                    const btn = document.createElement('button');
                    btn.innerHTML = `${theme.name} - ${theme.price} <img src='./images/currencyimage.png' alt='Coin' class='coin-icon'>`;
                    btn.className = 'themeBtn shopBtn';
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                    btn.style.marginBottom = '8px';
                    btn.onclick = function() {
                        if (coins >= theme.price) {
                            subtractCoins(theme.price);
                            ownedThemes.push(theme.name);
                            localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
                            renderShop();
                            renderInventory();
                        } else {
                            showCustomAlert("Not enough coins!", "error");
                        }
                    };
                    col.appendChild(btn);
                });
                bundlesRow.appendChild(col);
            });
            shopDiv.appendChild(bundlesRow);
            if (shopDiv.innerHTML === '') {
                shopDiv.innerHTML = '<p style="text-align:center; color:#888;">All themes owned!</p>';
            }
        }

        function renderInventory() {
            const invDiv = document.getElementById('inventoryThemes');
            invDiv.innerHTML = '';
            // Group owned themes by bundle
            const bundleMap = {};
            ownedThemes.forEach(themeName => {
                const theme = themes.find(t => t.name === themeName);
                const bundle = theme.bundle || 'Other';
                if (!bundleMap[bundle]) bundleMap[bundle] = [];
                bundleMap[bundle].push(theme);
            });
            invDiv.innerHTML = '';
            const bundleNames = Object.keys(bundleMap);
            bundleNames.forEach(bundle => {
                const col = document.createElement('div');
                col.style.display = 'flex';
                col.style.flexWrap = 'wrap';
                col.style.alignItems = 'center';
                col.style.minWidth = '180px';
                col.style.marginBottom = '12px';
                // Use first theme's text color for bundle label
                const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
                const firstTheme = bundleMap[bundle][0];
                const bundleLabel = document.createElement('div');
                bundleLabel.textContent = bundle;
                bundleLabel.className = 'bundle-label';
                bundleLabel.style.color = themeObj.text;
                bundleLabel.style.fontWeight = 'bold';
                bundleLabel.style.fontSize = '1.1em';
                bundleLabel.style.marginBottom = '8px';
                col.appendChild(bundleLabel);
                bundleMap[bundle].forEach(theme => {
                    const btn = document.createElement('button');
                    btn.textContent = theme.name;
                    btn.className = 'themeBtn owned' + (selectedTheme === theme.name ? ' selected' : '');
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                    btn.style.marginBottom = '8px';
                    btn.onclick = function() {
                        selectTheme(theme.name);
                    };
                    col.appendChild(btn);
                });
                invDiv.appendChild(col);
            });
        }

        function selectTheme(themeName) {
          
            selectedTheme = themeName;
            const theme = themes.find(t => t.name === themeName);
          //      const fontstyle = choosentheme.FS || "";

          //Update top bar
          document.querySelector('meta[name="theme-color"]').setAttribute('content', theme.Tb);
          //Update head

            document.body.style.background = theme.bg;
            document.querySelector('.container').style.background = theme.bg;
            document.getElementById('mainTitle').style.color = theme.title || theme.text;
               document.getElementById('CounterTitle').style.color = theme.title || theme.text;
            document.getElementById('shopTitle').style.color = theme.title || theme.text;
            document.getElementById('settingsTitle').style.color = theme.title || theme.text;
            document.querySelector('.container').style.color = theme.text;
            document.getElementById('todoListContainer').style.background = theme.Tb;
             
       
        
            // Update only inventory themeBtn buttons (not shopBtn)
            document.querySelectorAll('.themeBtn').forEach(btn => {
                if (!btn.classList.contains('shopBtn')) {
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                }
            });
            // Update bundle label colors in inventory columns
            document.querySelectorAll('.bundle-label').forEach(label => {
                label.style.color = theme.text;
            });

            // Update control buttons (Start, Pause, Reset)
            document.getElementById('startBtn').style.background = theme.btn;
            document.getElementById('startBtn').style.color = theme.text;
            document.getElementById('pauseBtn').style.background = theme.btn;
            document.getElementById('pauseBtn').style.color = theme.text;
            document.getElementById('resetBtn').style.background = theme.btn;
            document.getElementById('resetBtn').style.color = theme.text;

            // Update break timer buttons
            document.getElementById('breakStartBtn').style.background = theme.btn;
            document.getElementById('breakStartBtn').style.color = theme.text;
            document.getElementById('breakPauseBtn').style.background = theme.btn;
            document.getElementById('breakPauseBtn').style.color = theme.text;
            document.getElementById('breakResetBtn').style.background = theme.btn;
            document.getElementById('breakResetBtn').style.color = theme.text;

            //Update stopwatch buttons
            document.getElementById('stopwatchStartBtn').style.background = theme.btn;
            document.getElementById('stopwatchStartBtn').style.color = theme.text;
            document.getElementById('stopwatchPauseBtn').style.background = theme.btn;
            document.getElementById('stopwatchPauseBtn').style.color = theme.text;
            document.getElementById('stopwatchResetBtn').style.background = theme.btn;
            document.getElementById('stopwatchResetBtn').style.color = theme.text;
         

            // Update tab buttons
            document.getElementById('pomodoroTabBtn').style.background = theme.btn;
            document.getElementById('pomodoroTabBtn').style.color = theme.text;
            document.getElementById('shopTabBtn').style.background = theme.btn;
            document.getElementById('shopTabBtn').style.color = theme.text;
            document.getElementById('settingsTabBtn').style.background = theme.btn;
            document.getElementById('settingsTabBtn').style.color = theme.text;
            document.getElementById('todoTabBtn').style.background = theme.btn;
            document.getElementById('todoTabBtn').style.color = theme.text;
            document.getElementById('addActivityBtn').style.background = theme.btn;
            document.getElementById('addActivityBtn').style.color = theme.text;
                      //Settings tab buttons
            document.getElementById('settingsPomodoroTabBtn').style.background = theme.btn;
            document.getElementById('settingsPomodoroTabBtn').style.color = theme.text;
            document.getElementById('settingsDataTabBtn').style.background = theme.btn;
            document.getElementById('settingsDataTabBtn').style.color = theme.text;
            // Style settings wipe button
            if (document.getElementById('deleteDataBtn')) {
                document.getElementById('deleteDataBtn').style.background = theme.btn;
                document.getElementById('deleteDataBtn').style.color = theme.text;
            }
            document.getElementById('changeDataBtn').style.background = theme.bg;
            document.getElementById('changeDataBtn').style.color = theme.text;
            // PIN setting buttons
            document.getElementById('setPinBtn').style.background = theme.btn;
            document.getElementById('setPinBtn').style.color = theme.text;
            document.getElementById('clearPinBtn').style.background = theme.btn;
            document.getElementById('clearPinBtn').style.color = theme.text;
          
        
            // Style progress bar
            if (document.getElementById('progressBar')) {
                document.getElementById('progressBar').style.background = theme.btn;
            }
            // Style To Do List tab: week day containers and activities
            for (let i = 0; i < 7; i++) {
                // Day container background and text
                const dayContainer = document.getElementById('todoDay' + i);
                if (dayContainer) {
                    dayContainer.style.background = theme.Tb;
                    dayContainer.style.color = theme.text;
                }
                // Day title
                const dayTitle = dayContainer ? dayContainer.querySelector('h3') : null;
                if (dayTitle) {
                    dayTitle.style.color = theme.text;
                }
                // Completion estimate
                const estimate = document.getElementById('completionEstimate' + i);
                if (estimate) {
                    estimate.style.color = theme.text;
                }
                // Add Activity button
                const addBtn = document.getElementById('addActivityBtn' + i);
                if (addBtn) {
                    addBtn.style.background = theme.btn;
                    addBtn.style.color = theme.text;
                }
                // Activities
                const activityList = document.getElementById('activityList');
                if (activityList) {
                    activityList.querySelectorAll('.activity').forEach(div => {
                        div.style.background = theme.bg;
                        div.style.color = theme.text;
                    });
                    activityList.querySelectorAll('.activityCompleteBtn').forEach(btn => {
                        btn.style.background = theme.btn;
                        btn.style.color = theme.text;
                    });
                }
            }
            // Modal buttons
            document.getElementById('confirmActivityBtn').style.background = theme.btn;
            document.getElementById('confirmActivityBtn').style.color = theme.text;
            document.getElementById('cancelActivityBtn').style.background = theme.btn;
            document.getElementById('cancelActivityBtn').style.color = theme.text;
            // Top bar and app title
            document.getElementById('topBar').style.background = theme.Tb;
            document.getElementById('AppTitle').style.color = theme.text;
            renderInventory();
        }

        // Initial render
        // Load coins, inventory, and goal from localStorage and reset if needed
        function loadAllData() {
            const saved = localStorage.getItem('pomodoroCoins');
            const lastReset = localStorage.getItem('pomodoroLastReset');
            const today = getTodayString();
            const hour = getCurrentHour();
            // Load Gems
            const savedgems = localStorage.getItem('pomodoroCoins');
            // Load inventory
            const inv = localStorage.getItem('pomodoroInventory');
            ownedThemes = inv ? JSON.parse(inv) : ["Classic"];
            // Load goal
            const savedGoal = localStorage.getItem('pomodoroGoal');
            goal = savedGoal ? parseInt(savedGoal) : 100;
            document.getElementById('goalInput').value = goal;
                coins = saved ? parseInt(saved) : 0;
            
        }
        loadAllData();
        updateTimerDisplay();
        updateBreakTimerDisplay();
        updateStopwatchDisplay();
        updateCoinsDisplay();
        renderShop();
        renderInventory();
        selectTheme(selectedTheme);
        // --- Ensure To Do List is loaded on page load ---
        

        updateProgressBar();
        showTimerMode(getSelectedTimerMode());


        // Goal input change
        
        function SetGoal(NewGoal) {
            goal = parseInt(NewGoal) || 1;
            localStorage.setItem('pomodoroGoal', goal);
            updateProgressBar();
            document.getElementById('goalInput').value = goal;
            document.getElementById('goalLabel').textContent = `Goal: ${goal} coins`;  
            showCustomAlert(`Goal set to ${goal} coins!`, "info");
            updateProgressBar();


        }
        if (document.getElementById('goalInput')) {
            document.getElementById('goalInput').addEventListener('change', function() {
           SetGoal(this.value);
            });
        }

        // To Do List logic



// --- Single To Do List Container ---
let todoActivities = [];

function loadTodoActivities() {
    const saved = localStorage.getItem('pomodoroActivities');
    todoActivities = saved ? JSON.parse(saved) : [];
    calculateCompletionTimeEstimate();
    renderTodoActivities();
}
function saveTodoActivities() {
    localStorage.setItem('pomodoroActivities', JSON.stringify(todoActivities));
}
function renderTodoActivities() {
    const list = document.getElementById('activityList');
    list.innerHTML = '';
    if (todoActivities.length === 0) {
        list.innerHTML = '<p style="color:#888; text-align:center; font-size:1.2em;">No activities yet.</p>';
        return;
    }
    const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
    todoActivities.forEach((act, idx) => {
        const div = document.createElement('div');
        div.className = 'activity';
        div.style.setProperty('--activity-bg', themeObj.bg);
        div.style.setProperty('--activity-text', themeObj.text);
        // Responsive content
        const nameSpan = document.createElement('span');
        nameSpan.textContent = act.name;
        nameSpan.style.fontWeight = 'bold';
        const priceSpan = document.createElement('span');
        priceSpan.innerHTML = `${act.price} <img src='./images/currencyimage.png' alt='Coin' class='coin-icon'> `;
        priceSpan.style.marginLeft = '1em';
        // Complete button
        const btn = document.createElement('button');
        btn.textContent = 'Complete';
        btn.className = 'settingsBtn activityCompleteBtn';
        btn.style.background = themeObj.btn;
        btn.style.color = themeObj.text;
        btn.onclick = function() {
            if (coins >= act.price) {
                subtractCoins(act.price);
                todoActivities.splice(idx, 1);
                saveTodoActivities();
                renderTodoActivities();
                showCustomAlert(`Completed: ${act.name}`, "success");
                calculateCompletionTimeEstimate();
            } else {
                showCustomAlert("Not enough coins!", "error");
            }
        };
        // Set Goal button
        const goalbtn = document.createElement('button');
        goalbtn.textContent = 'Set Goal';
        goalbtn.className = 'settingsBtn activityCompleteBtn goalBtn';
        goalbtn.style.background = themeObj.btn;
        goalbtn.style.color = themeObj.text;
        goalbtn.onclick = function() {
            if (coins < act.price) {
                SetGoal(act.price);
                showCustomAlert(`Goal set to: ${act.price}`, "success");
            } else {
                showCustomAlert("You already have enough coins to complete this activity", "info");
            }
        };
        div.appendChild(nameSpan);
        div.appendChild(priceSpan);
        div.appendChild(btn);
        div.appendChild(goalbtn);
        list.appendChild(div);
    });
    // Save todoActivities after rendering (in case of any changes)
    saveTodoActivities();
}
loadTodoActivities();


function calculateCompletionTimeEstimate() {
    const totalTaskCoins = todoActivities.reduce((sum, task) => sum + task.price, 0);
    const netCoinsNeeded = totalTaskCoins - coins;
    const estimateElement = document.getElementById('completionEstimate');
    if (totalTaskCoins === 0) {
        estimateElement.textContent = "No tasks available.";
        return;
    }
    if (netCoinsNeeded <= 0) {
        estimateElement.textContent = "All tasks can be completed with current coins!";
        return;
    }
    const now = new Date();
    const finishTime = new Date(now.getTime() + netCoinsNeeded * 60000);
    const hours = finishTime.getHours().toString().padStart(2, '0');
    const minutes = finishTime.getMinutes().toString().padStart(2, '0');
    const timeString = `${hours}:${minutes}`;
    estimateElement.textContent = `Estimated finish time: ${timeString} / ${netCoinsNeeded} more coins needed / ${totalTaskCoins} total task coins`;
}
// Modal logic
const modal = document.getElementById('activityModal');
document.getElementById('addActivityBtn').onclick = function() {

   

    modal.style.display = 'flex';
    document.getElementById('activityNameInput').value = '';
    document.getElementById('activityPriceInput').value = 10;
};
document.getElementById('cancelActivityBtn').onclick = function() {
    modal.style.display = 'none';
};
document.getElementById('confirmActivityBtn').onclick = function() {
    const name = document.getElementById('activityNameInput').value.trim();
    const price = parseInt(document.getElementById('activityPriceInput').value);
    if (!name || !price || price < 1) {
        alert('Please enter a valid name and coin price.');
        return;
    }
    todoActivities.push({ name, price });
    saveTodoActivities();
    renderTodoActivities();
    modal.style.display = 'none';
    calculateCompletionTimeEstimate();
};

// --- Auto Delete Countdown & Logic ---  
let lastAutoDeleteRun = null;


function updateAutoDeleteCountdown() {


  const enable = document.getElementById('autoDeleteEnable').checked;
 

  const now = new Date();
  const targetDay = parseInt(document.getElementById('autoDeleteDay').value);
  const targetHour = parseInt(document.getElementById('autoDeleteHour').value);
  const targetMinute = parseInt(document.getElementById('autoDeleteMinute').value);
  let daysAhead = (targetDay - now.getDay() + 7) % 7;
  let nextDelete = new Date(now.getFullYear(), now.getMonth(), now.getDate(), targetHour, targetMinute, 0, 0);
 // --- FIX: If today is the target day and the target time is still ahead, use today ---
  if (daysAhead === 0) {
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    const targetMinutes = targetHour * 60 + targetMinute;
    if (nowMinutes < targetMinutes) {
      // Target time is still ahead today, keep daysAhead = 0
      console.log(targetMinutes-nowMinutes);
    


  

    } else if (nowMinutes === targetMinutes) {
      // Target time is exactly now, keep daysAhead = 0
      
    } else {
      // Target time has passed today, schedule for next week
      daysAhead = 7;
    }
  }
  nextDelete.setDate(nextDelete.getDate() + daysAhead);
  const msLeft = nextDelete - now;


  if (msLeft <= 0) {

     if (!enable) {
    document.getElementById('autoDeleteCountdown').textContent = 'Next auto delete in: Now, Disabled';
    return;
  }
 
    // Only run auto delete once per scheduled time
    const lastRun = localStorage.getItem('pomodoroLastAutoDeleteRun');
    const nextDeleteKey = nextDelete.toISOString().slice(0,16); // YYYY-MM-DDTHH:MM
    if (lastRun !== nextDeleteKey) {
      const type = document.getElementById('autoDeleteType').value;
      console.log(`Running auto delete for type: ${type}`);
      DeleteData(type);
      localStorage.setItem('pomodoroLastAutoDeleteRun', nextDeleteKey);
    }

       document.getElementById('autoDeleteCountdown').textContent = 'Deleted!';
    return;


  } else if  (msLeft <= 60000) {
    // Less than 1 minute left, show countdown in seconds
      document.getElementById('autoDeleteCountdown').textContent = 'Next auto delete in: <1 min';
    return;
  }
  const totalMinutes = Math.floor(msLeft / 60000);
  const days = Math.floor(totalMinutes / 1440);
  const hours = Math.floor((totalMinutes % 1440) / 60);
  const minutes = totalMinutes % 60;
  let label = 'Next auto delete in: ';
  if (days > 0) label += days + 'd ';
  if (hours > 0) label += hours + 'h ';
  label += minutes + 'm';
  document.getElementById('autoDeleteCountdown').textContent = label;
}
setInterval(updateAutoDeleteCountdown, 10000);

function AutoDeleteProtector() {

  document.getElementById('autoDeleteEnable').checked = false;
}

document.getElementById('autoDeleteDay').addEventListener('change', updateAutoDeleteCountdown);
document.getElementById('autoDeleteHour').addEventListener('change', updateAutoDeleteCountdown);
document.getElementById('autoDeleteMinute').addEventListener('change', updateAutoDeleteCountdown);
document.getElementById('autoDeleteDay').addEventListener('change', AutoDeleteProtector);
document.getElementById('autoDeleteHour').addEventListener('change', AutoDeleteProtector);
document.getElementById('autoDeleteMinute').addEventListener('change', AutoDeleteProtector);

updateAutoDeleteCountdown();

// --- Auto Delete Logic ---  

function DeleteData(datatype) {


  // Clear the specified data type
   
   if (datatype === 'coins') {
        coins = 0;
        saveCoins();
        updateCoinsDisplay();
        updateProgressBar();
        showCustomAlert('Coin data deleted!', 'success');
        
      } else if (datatype === 'inventory') {
        ownedThemes = ['Classic','Night'];
        localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
        renderInventory();
        showCustomAlert('Inventory data deleted!', 'success');

 

      } else {
        coins = 0;
        saveCoins();
        updateCoinsDisplay();
        updateProgressBar();
        ownedThemes = ['Classic','Night'];
        localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
        renderInventory();
        showCustomAlert('Coin and inventory data deleted!', 'success');
      }
        renderShop(); // reload shop after data deletion

}

// --- Manual Delete Button Logic ---
if (document.getElementById('deleteDataBtn')) {
    document.getElementById('deleteDataBtn').addEventListener('click', function() {
      const type = document.getElementById('manualDeleteType').value;

  if (confirm("Are you sure you want to delete " + type + " data? This cannot be undone.")) {
  // Kullanıcı "Tamam" dedi
  console.log("Confirmed");
   DeleteData(type);

} else {
  // Kullanıcı "İptal" dedi
  console.log("Cancelled by user.");
  

}
  
    });
}


   
// --- Save & Load Settings ---
function saveSettings() {
  localStorage.setItem('pomodoroAutoDeleteEnable', document.getElementById('autoDeleteEnable').checked ? '1' : '0');
  localStorage.setItem('pomodoroAutoDeleteDay', document.getElementById('autoDeleteDay').value);
  localStorage.setItem('pomodoroAutoDeleteHour', document.getElementById('autoDeleteHour').value);
  localStorage.setItem('pomodoroAutoDeleteMinute', document.getElementById('autoDeleteMinute').value);
  localStorage.setItem('pomodoroAutoDeleteType', document.getElementById('autoDeleteType').value);
  localStorage.setItem('pomodoroManualDeleteType', document.getElementById('manualDeleteType').value);
  localStorage.setItem('pomodoroSettingOne', document.getElementById('SettingOne').checked ? '1' : '0');
  localStorage.setItem('pomodoroAutoStartBreak', document.getElementById('AutoStartBreak').checked ? '1' : '0');
  localStorage.setItem('pomodoroAutoStartStudy', document.getElementById('AutoStartStudy').checked ? '1' : '0');
}
function loadSettings() {
  document.getElementById('autoDeleteEnable').checked = localStorage.getItem('pomodoroAutoDeleteEnable') === '1';
  if (localStorage.getItem('pomodoroAutoDeleteDay')) document.getElementById('autoDeleteDay').value = localStorage.getItem('pomodoroAutoDeleteDay');
  if (localStorage.getItem('pomodoroAutoDeleteHour')) document.getElementById('autoDeleteHour').value = localStorage.getItem('pomodoroAutoDeleteHour');
  if (localStorage.getItem('pomodoroAutoDeleteMinute')) document.getElementById('autoDeleteMinute').value = localStorage.getItem('pomodoroAutoDeleteMinute');
  if (localStorage.getItem('pomodoroAutoDeleteType')) document.getElementById('autoDeleteType').value = localStorage.getItem('pomodoroAutoDeleteType');
  if (localStorage.getItem('pomodoroManualDeleteType')) document.getElementById('manualDeleteType').value = localStorage.getItem('pomodoroManualDeleteType');
  document.getElementById('SettingOne').checked = localStorage.getItem('pomodoroSettingOne') === '1';
  document.getElementById('AutoStartBreak').checked = localStorage.getItem('pomodoroAutoStartBreak') === '1';
  document.getElementById('AutoStartStudy').checked = localStorage.getItem('pomodoroAutoStartStudy') === '1';
}
// Attach saveSettings to all relevant controls
['autoDeleteEnable','autoDeleteDay','autoDeleteHour','autoDeleteType','manualDeleteType','SettingOne','AutoStartBreak','AutoStartStudy'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', saveSettings);
});
loadSettings();
updateAutoDeleteCountdown();

// window.addEventListener("beforeunload", function (e) {
  // Mesajı göster
  //e.preventDefault(); // Bazı tarayıcılarda gerekli
  //e.returnValue = ''; // Chrome gibi modern tarayıcılar için bu satır şart
  
  // Not: return değeri kullanıcıya gösterilmez, sadece uyarı çıkmasını sağlar.
//});

// Ensure only Pomodoro tab is visible on load
window.addEventListener('DOMContentLoaded', function() {
  document.getElementById('SettingTabPomodoro').style.display = 'block';
  document.getElementById('SettingTabData').style.display = 'none';
  document.getElementById('settingsPomodoroTabBtn').classList.add('active');
  document.getElementById('settingsDataTabBtn').classList.remove('active');
});
    </script>
</body>
</html>
