<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pomocoin</title>
   <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffeb3b" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
  


/* --- Responsive Layout & Flexbox --- */
body {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap; /* Allow wrapping for side panel */
  justify-content: center;
  align-items: flex-start;
  gap: 32px; /* Add gap between panels */
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 0;
  transition: background 0.3s;
}
.container {
  max-width: 1500px;
  width: 100%; /* Use full width up to max-width */
  margin: 40px auto;
  background: #fff;
  padding: 2em; /* Use em for scalable padding */
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  box-sizing: border-box;
  flex: 1 1 350px; /* Flex grow/shrink, min width */
}
.responsive-image {
  width: 100%;        /* container kadar genişle */
  max-width: 75px;   /* ama en fazla 500px */
  min-width: 50px;   /* en az 150px */
  height: auto;       /* oranı koru */
  display: block;
  margin: 0 auto;     /* ortala */
  border-radius: 12px; /* istersen köşe yumuşatma */
}

h1 {
  text-align: center;
  color: #d35400;
  font-size: 2em;
}
.coins {
  font-size: 1.2em;
  margin-bottom: 1em;
  text-align: center;
}
.timer {
  font-size: 2.5em;
  text-align: center;
  margin: 1.5em 0;
}
.controls {
  text-align: center;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
}
button {
  background: #d35400;
  color: #fff;
  border: none;
  padding: 10px 24px;
  margin: 0 8px;
  border-radius: 4px;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s;
  max-width: 100%;
  box-sizing: border-box;
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.5;
  transition: opacity 0.3s;
}
.tabBtn {
  background: #eee;
  color: #d35400;
  border: none;
  padding: 8px 24px;
  margin: 2 4px 16px 4px;
  border-radius: 4px 4px 4px 4px;
  font-size: 1em;
  cursor: pointer;
  max-width: 100%;
}
.tabBtn.active {
  background: #d35400;
  color: #fff;
}
.tabContent {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.themeBtn {
  margin: 8px;
  padding: 8px 16px;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  max-width: 100%;
}

.themeBtn.selected { box-shadow: 0 0 8px #27ae60; }
#AppTitle {
  font-size: 24px;
  font-weight: bold;
  color: #333;
  text-align: center;
  margin-top: 0;
   margin-left: 10px;
}
#progressBarContainer {
  background: #eee;
  border-radius: 8px;
  height: 24px;
  position: relative;
  overflow: hidden;
  margin-top: 8px;
  width: 100%;
  max-width: 100%;
}
#progressBar {
  background: #d35400;
  height: 100%;
  width: 0%;
  border-radius: 8px;
  transition: width 0.3s;
}
#progressText {
  position: absolute;
  left: 50%;
  top: 0;
  transform: translateX(-50%);
  color: #222;
  font-weight: bold;
  line-height: 24px;
  font-size: 1em;
}
.settingsBtn {
  background: #d35400;
  color: #fff;
  border: none;
  padding: 10px 24px;
  border-radius: 4px;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.3s, color 0.3s;
  max-width: 100%;
  box-sizing: border-box;
}
.settingsBtn:disabled {
  background: #ccc;
  color: #888;
  cursor: not-allowed;
}
/* Remove transform for responsive layout */
#sideApp, #mainApp {
  transform: none;
}

/* --- Custom Alert Responsive Positioning --- */
#customAlert {
  display: none;
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #2ecc71;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 9999;
  transition: opacity 0.3s;
  max-width: 90vw;
  text-align: center;
  word-break: break-word;
}

/* --- Top Navigation Bar & Divider --- */
#topBar {
  width: 100vw;
  min-width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--theme-bg, #f4f4f4);
  padding: 0.5em 1em;
  box-sizing: border-box;
  position: sticky;
  top: 0;
  z-index: 100;
}
#logoPlaceholder {
  width: 48px;
  height: 48px;
  background: #eee;
  border-radius: 8px;
  margin-right: 1em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  color: #bbb;
}
#navTabs {
  display: flex;
  align-items: center;
  gap: 0.5em;
  flex: 1;
}
#navTitle {
  font-size: 1.3em;
  font-weight: bold;
  margin-right: 1.5em;
  color: var(--theme-title, #d35400);
  transition: color 0.3s;
}
@media (max-width: 768px) {
  #topBar {
    flex-direction: column;
    align-items: stretch;
    padding: 0.5em 0.5em;
  }
  #logoPlaceholder {
    margin: 0 auto 0.5em auto;
  }
  #navTabs {
    flex-direction: column;
    gap: 0.5em;
    align-items: flex-start;
  }
  #navTitle {
    margin-right: 0;
    margin-bottom: 0.5em;
  }
  #dividerLine {
    height: 36px;
  }
}
@media (max-width: 480px) {
  #topBar {
    padding: 0.25em 0.25em;
  }
  #logoPlaceholder {
    width: 36px;
    height: 36px;
    font-size: 1em;
  }
  #navTitle {
    font-size: 1em;
  }
  #dividerLine {
    height: 24px;
  }
}

/* --- Responsive Media Queries --- */
@media (max-width: 768px) {
  body {
    flex-direction: column;
    gap: 16px;
    align-items: center;
  }
  .container {
    max-width: 98vw;
    margin: 16px auto;
    padding: 1em;
    font-size: 1em;
  }
  h2 {
    font-size: 1.5em;
      text-align: center;
  }
  .timer {
    font-size: 2em;
  }
  #customAlert {
    font-size: 15px;
    top: 10px;
    padding: 10px 12px;
    max-width: 98vw;
  }
}
@media (max-width: 480px) {
  .container {
    max-width: 100vw;
    margin: 8px auto;
    padding: 0.5em;
    font-size: 0.95em;
  }
  h1 {
    font-size: 1.2em;
  }
  .timer {
    font-size: 1.2em;
  }
  button, .settingsBtn, .themeBtn {
    font-size: 0.95em;
    padding: 8px 8px;
    margin: 4px 2px;
  }
  #customAlert {
    font-size: 13px;
    top: 5px;
    padding: 8px 6px;
    max-width: 99vw;
  }
}
/* --- End Responsive Layout --- */
    </style>
</head>
    <!-- Service Worker Registration for PWA -->
    <script>
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registration successful:', registration);

        // Güncelleme algılama event’i burada
        registration.addEventListener('updatefound', () => {
          const newSW = registration.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              // Yeni sürüm yüklendi, kullanıcıya bildir
              alert('A new version is available! Please refresh the page.');
            }
          });
        });

      })
      .catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}


    </script>
</body>
<div id="topBar">
   <img src="./images/icon1.png" alt="Pomocoin" class="responsive-image">



  <span id="AppTitle"> Pomocoin </span>

    <div id="navTabs">
        <button class="tabBtn active" id="pomodoroTabBtn">Pomodoro</button>
        <button class="tabBtn" id="shopTabBtn">Shop</button>
        <button class="tabBtn" id="settingsTabBtn">Settings</button>
        <button class="tabBtn" id="todoTabBtn">To Do List</button>
    </div>
</div>
<!-- Divider Line -->


    <div class="container" id = "mainApp">
        <h1 id="mainTitle" style="display:none;"></h1>
        <div class="tabContents">
            <div id="pomodoroTab" class="tabContent" style="display:block;">
                     <h2 id="CounterTitle" style="text-align:center; color:#0b0b0b;">Pomodoro</h2>
                <div class="coins">Coins: <span id="coinCount">0</span></div>
                <div style="text-align:center; margin-bottom:16px;">
                    <label for="pomodoroTime">Set Time (minutes): </label>
                    <input type="number" id="pomodoroTime" min="1" max="120" value="25" style="width:60px;">
                </div>
                <div class="timer" id="timer">25:00</div>
                <div class="controls">
                    <button id="startBtn">Start</button>
                    <button id="pauseBtn" disabled>Pause</button>
                    <button id="resetBtn">Reset</button>
                </div>
                <p style="text-align:center; color:#888; margin-top:24px;">
                    Earn 1 coin for every minute you study!
                </p>
                  <div style="text-align:center; margin:24px 0;">
                    <label for="goalInput">Set Goal (coins): </label>
                    <input type="number" id="goalInput" min="1" value="100" style="width:80px;">
                </div>
                <div style="text-align:center; margin:24px 0;">
                    <div style="width:90%;margin:auto;">
                        <div id="progressBarContainer">
                            <div id="progressBar"></div>
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="shopTab" class="tabContent" style="display:none;">
                          <h2 id="shopTitle" style="text-align:center; color:#d35400;">Shop</h2>
                <div class="coins">Coins: <span id="coinCountShop">0</span></div>
      
                <div id="themesShop" style="margin-bottom:24px;"></div>
                <h3 style="text-align:center; color:#888;">Inventory</h3>
                <div id="inventoryThemes" style="text-align:center;"></div>
            </div>


            <div id="settingsTab" class="tabContent" style="display:none;">
                <h2 style="text-align:center;" id="settingsTitle">Settings</h2>
                <div style="text-align:center; margin:24px 0;">
                    <button id="deleteDataBtn" class="settingsBtn">Delete Coin & Inventory Data</button>
                </div>
              
            </div>
            <!-- New To Do List Tab -->
            <div id="todoTab" class="tabContent" style="display:none;">
                <h2 style="text-align:center;">To Do List</h2>
                <div class="coins">Coins: <span id="coinCountTDL">0</span></div>
                <div id="weekTodoLists">
                  <!-- 7 containers for each day, displayed as columns -->
                  <div style="display: flex; flex-direction: row; gap: 16px; justify-content: center; align-items: flex-start; flex-wrap: wrap;">
                    <div class="todoDayContainer" id="todoDay0" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Monday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate0">Estimated finish time: --:--</p>
                      <button id="addActivityBtn0" class="settingsBtn">Add Activity</button>
                      <div id="activityList0"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay1" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Tuesday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate1">Estimated finish time: --:--</p>
                      <button id="addActivityBtn1" class="settingsBtn">Add Activity</button>
                      <div id="activityList1"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay2" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Wednesday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate2">Estimated finish time: --:--</p>
                      <button id="addActivityBtn2" class="settingsBtn">Add Activity</button>
                      <div id="activityList2"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay3" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Thursday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate3">Estimated finish time: --:--</p>
                      <button id="addActivityBtn3" class="settingsBtn">Add Activity</button>
                      <div id="activityList3"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay4" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Friday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate4">Estimated finish time: --:--</p>
                      <button id="addActivityBtn4" class="settingsBtn">Add Activity</button>
                      <div id="activityList4"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay5" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Saturday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate5">Estimated finish time: --:--</p>
                      <button id="addActivityBtn5" class="settingsBtn">Add Activity</button>
                      <div id="activityList5"></div>
                    </div>
                    <div class="todoDayContainer" id="todoDay6" style="flex:1 1 180px; min-width:110px; max-width:140px; margin-bottom:32px; border-radius:8px; background:#f8f8f8; box-shadow:0 1px 4px rgba(0,0,0,0.07); padding:16px;">
                      <h3 style="text-align:center; color:#d35400; margin-top:0;">Sunday</h3>
                      <p style="text-align:center; color:#888;" id="completionEstimate6">Estimated finish time: --:--</p>
                      <button id="addActivityBtn6" class="settingsBtn">Add Activity</button>
                      <div id="activityList6"></div>
                    </div>
                  </div>
                </div>
                <div id="customAlert" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #2ecc71; color: white; padding: 12px 24px; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 9999; transition: opacity 0.3s; max-width: 90vw; text-align: center; word-break: break-word;"></div>
            </div>
        </div>
    </div>

    <!-- Pomodoro -->
<div id="activityModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:300px; max-width:90vw; margin:auto;">
        <h3 style="margin-top:0;">Add Activity</h3>
        <label>Activity Name:</label>
        <input type="text" id="activityNameInput" style="width:100%; margin-bottom:12px;">
        <label>Coin Price:</label>
        <input type="number" id="activityPriceInput" min="1" value="10" style="width:100%; margin-bottom:12px;">
        <div style="text-align:right;">
            <button id="confirmActivityBtn" class="settingsBtn">Confirm</button>
            <button id="cancelActivityBtn" class="settingsBtn" style="background:#ccc; color:#222;">Cancel</button>
        </div>
    </div>
</div>

    <script>
        // Pomodoro logic
        let timer = 25 * 60;
        let interval = null;
        let coins = 0; // coin balance is loaded from localStorage
        let lastMinute = 25;
        let pomodoroDuration = 25;

        // --- Persistent Coin Logic ---
        // Save/load coins and last reset date from localStorage
function getTodayString() {
    // Returns YYYY-MM-DD for local time
    const now = new Date();
    return now.getFullYear() + '-' + (now.getMonth()+1).toString().padStart(2,'0') + '-' + now.getDate().toString().padStart(2,'0');
}

function isSunday() {
    // Returns true if today is Sunday
    return new Date().getDay() === 0;
}

        function getCurrentHour() {
            return new Date().getHours();
        }

function loadCoins() {
    const saved = localStorage.getItem('pomodoroCoins');
    const lastReset = localStorage.getItem('pomodoroLastReset');
    const today = getTodayString();
    const hour = getCurrentHour();
    // Only reset coins at 01:00 on Sundays
    if (isSunday() && lastReset !== today && hour >= 1) {
        coins = 0;
        localStorage.setItem('pomodoroCoins', coins);
        localStorage.setItem('pomodoroLastReset', today);
    } else {
        coins = saved ? parseInt(saved) : 0;
    }
}

        function saveCoins() {
            localStorage.setItem('pomodoroCoins', coins);
        }

        function addCoins(amount) {
            coins += amount;
            saveCoins();
            updateCoinsDisplay();
            updateProgressBar();
        }

        function subtractCoins(amount) {
            coins = Math.max(0, coins - amount);
            saveCoins();
            updateCoinsDisplay();
        }

// Bonus: interval checker to reset coins at 1:00 AM on Sundays if page is open
setInterval(() => {
    const today = getTodayString();
    const hour = getCurrentHour();
    const lastReset = localStorage.getItem('pomodoroLastReset');
    if (isSunday() && lastReset !== today && hour >= 1) {
        coins = 0;
        ownedThemes = ["Classic"];
        localStorage.setItem('pomodoroCoins', coins);
        localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
        localStorage.setItem('pomodoroLastReset', today);
        updateCoinsDisplay();
        renderInventory();
        updateProgressBar();
    }
}, 60000); // check every minute

        // --- End Persistent Coin Logic ---

        // Custom Alert
function showCustomAlert(message, type = 'success', duration = 3000) {
    const alertBox = document.getElementById('customAlert');
    alertBox.textContent = message;

    // Renkleri belirle
    let bgColor = '#2ecc71'; // success
    if (type === 'error') bgColor = '#e74c3c';
    if (type === 'info') bgColor = '#3498db';

    alertBox.style.backgroundColor = bgColor;
    alertBox.style.display = 'block';
    alertBox.style.opacity = '1';

    setTimeout(() => {
        alertBox.style.opacity = '0';
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 300);
    }, duration);
}


        // Theme shop logic
         const themes = [
            { name: "Classic", bundle: "Starter",price: 0, bg: "#f4f4f4", btn: "#fff9dc",Tb: "#e6e6e6", text: "#222",},
            { name: "Night", bundle: "Starter", price: 0, bg: "#222", btn: "#34495e",Tb: "#4f4f4f ", text: "#fff" ,},
           

            { name: "Monochrome", bundle: "Basic", price: 30, bg: "#f4f4f4", btn: "#f4f4f4",Tb: "#4f4f4f", text: "#222" ,},
            { name: "Coffee",bundle: "Basic", price: 30, bg: "#ffd9b6", btn: "#c09062 ",Tb: "#f0b883", text: "#222" ,},


{ name: "Forest",bundle: "Botanica", price: 45, bg: "#e8f5e9", btn: "#4caf50",Tb: "#c8e6c9", text: "#222" ,},
{ name: "Mint", bundle: "Botanica",price: 45, bg: "#e8f8f5", btn: "#16a085",Tb: "#aedaa0", text: "#222", },
{ name: "Lavender",bundle: "Botanica", price: 45, bg: "#f3e5f5", btn: "#9c27b0",Tb: "#d1c4e9", text: "#222" ,},

            { name: "Ocean",bundle: "Skynature", price: 60, bg: "#e0f7fa", btn: "#00bcd4",Tb: "#b2ebf2", text: "#222" ,},
            { name: "Sunset",bundle: "Skynature", price: 60, bg: "#fff3e0", btn: "#ff9800",Tb: "#ffe0b2", text: "#222" ,},
            { name: "Twilight", bundle: "Skynature",price: 60, bg: "#fce4ec", btn: "#e91e63",Tb: "#f8bbd0", text: "#222" ,},


  { name: "Lemon", bundle: "Fruit",price: 75, bg: "#fffde7", btn: "#ffeb3b",Tb: "#fff9c4", text: "#222" ,},
  { name: "Pineapple", bundle: "Fruit",price: 75, bg: "#fffde7", btn: "#f0e310",Tb: "#bdf17f", text: "#222" ,},
    { name: "Melon",bundle: "Fruit", price: 75, bg: "#ff9b89", btn: "#6dc053",Tb: "#de7c72", text: "#222" ,},
  { name: "Tomato", bundle: "Fruit",price: 75, bg: "#ffebee", btn: "#f44336",Tb: "#ffcdd2", text: "#222" ,},

  
    
          
            { name: "Slate", bundle: "Mineral Mist",price: 90, bg: "#eceff1", btn: "#607d8b",Tb: "#cfd8dc", text: "#222" ,},
            { name: "Violet", bundle: "Mineral Mist",price: 90, bg: "#bf9ae0", btn: "#763ef7",Tb: "#b886c2", text: "#222" ,},          
            { name: "Rose",bundle: "Mineral Mist", price: 90, bg: "#fff0f5", btn: "#e84393",Tb: "#dcbcd4", text: "#222" ,},

           
         { name: "Copper",bundle: "Royal Metals", price: 120, bg: "#ffccbc", btn: "#ff7043",Tb: "#ffab91", text: "#222" ,},
            { name: "Platinum", bundle: "Royal Metals",price: 120, bg: "#e0e0e0", btn: "#b0bec5",Tb: "#cfd8dc", text: "#222" ,},
                { name: "Bronze",bundle: "Royal Metals", price: 120, bg: "#f4f4f4", btn: "#cd7f32",Tb: "#d2b48c", text: "#222" ,},
              { name: "Silver",bundle: "Royal Metals", price: 120, bg: "#f5f5f5", btn: "#9e9e9e",Tb: "#bdbdbd", text: "#222" ,},
            { name: "Golden",bundle: "Royal Metals", price: 120, bg: "#ebd8aa", btn: "#FFC300",Tb: "#d9bf68", text: "#222" ,},


            
            {name: "Sapphire", bundle: "Gemstone", price: 180, bg: "#e3f2fd", btn: "#2196f3",Tb: "#bbdefb", text: "#222" ,},
            { name: "Amethyst", bundle: "Gemstone", price: 180, bg: "#E6D6F3", btn: "#6A4C93",Tb: "#B088CC", text: "#222" ,},
          { name: "Diamond", bundle: "Gemstone",price: 180, bg: "#F0F8FF", btn: "#8DA9C4",Tb: "#C8D8E4", text: "#222" ,},
          
           

    

           
           

          
          
            
           
          
             




        ];
        let ownedThemes = ["Night", "Classic"]; // Default owned themes
        let selectedTheme = "Classic";
        let goal = 100;

        function updateTimerDisplay() {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            document.getElementById('timer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
       function updateProgressBar() {
            let percent = Math.min(100, Math.floor((coins / goal) * 100));
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }
   
        function updateCoinsDisplay() {
            document.getElementById('coinCount').textContent = coins;
            document.getElementById('coinCountShop').textContent = coins;
            document.getElementById('coinCountTDL').textContent = coins;
         

        }

        function startTimer() {
            if (interval) return;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            interval = setInterval(() => {
                if (timer > 0) {
                    timer--;
                    const currentMinute = Math.floor(timer / 60);
                    if (timer % 60 === 0) { 
                        addCoins(1); // use persistent addCoins
                        lastMinute = currentMinute;
                   }// Close if here 
                
                    updateTimerDisplay();
                    calculateCompletionTimeEstimate();
                } else {
                    clearInterval(interval);
                    interval = null;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                }
            }, 1000);
        }

        function pauseTimer() {
            if (interval) {
                clearInterval(interval);
                interval = null;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            }
        }

        function resetTimer() {
            pauseTimer();
            pomodoroDuration = parseInt(document.getElementById('pomodoroTime').value) || 25;
            timer = pomodoroDuration * 60;
            lastMinute = pomodoroDuration;
            document.getElementById('pauseBtn').disabled = true;
            updateTimerDisplay();
        }

        document.getElementById('startBtn').addEventListener('click', startTimer);
        document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
        document.getElementById('resetBtn').addEventListener('click', resetTimer);
        document.getElementById('pomodoroTime').addEventListener('change', function() {
            resetTimer();
        });
             // Update completion estimate on activity list change

// Removed buggy calculateCompletionTimeEstimate function.
// The correct function for completion estimate is implemented for each day in the To Do List logic below.
   
        // Tab logic
       
        document.getElementById('pomodoroTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'block';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
            updateNavTitle('pomodoroTab');
        });
        document.getElementById('shopTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'block';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
            updateNavTitle('shopTab');
        });
        document.getElementById('settingsTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'block';
            document.getElementById('todoTab').style.display = 'none';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('todoTabBtn').classList.remove('active');
            updateNavTitle('settingsTab');
        });
        document.getElementById('todoTabBtn').addEventListener('click', function() {
            document.getElementById('pomodoroTab').style.display = 'none';
            document.getElementById('shopTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('todoTab').style.display = 'block';
            this.classList.add('active');
            document.getElementById('pomodoroTabBtn').classList.remove('active');
            document.getElementById('shopTabBtn').classList.remove('active');
            document.getElementById('settingsTabBtn').classList.remove('active');
            updateNavTitle('todoTab');
        });

        // Shop logic
        function renderShop() {
            const shopDiv = document.getElementById('themesShop');
            shopDiv.innerHTML = '';
            // Group themes by bundle
            const bundleMap = {};
            themes.forEach(theme => {
                if (!ownedThemes.includes(theme.name)) {
                    const bundle = theme.bundle || 'Other';
                    if (!bundleMap[bundle]) bundleMap[bundle] = [];
                    bundleMap[bundle].push(theme);
                }
            });
            shopDiv.innerHTML = '';
            const bundleNames = Object.keys(bundleMap);
            if (bundleNames.length === 0) {
                shopDiv.innerHTML = '<p style="text-align:center; color:#888;">All themes owned!</p>';
                return;
            }
            // Create columns for each bundle
            const bundlesRow = document.createElement('div');
            bundlesRow.style.display = 'flex';
            bundlesRow.style.flexWrap = 'wrap';
            bundlesRow.style.gap = '24px';
            bundleNames.forEach(bundle => {
                const col = document.createElement('div');
                col.style.display = 'flex';
                col.style.flexDirection = 'column';
                col.style.alignItems = 'center';
                col.style.minWidth = '180px';
                col.style.marginBottom = '16px';
                // Use first theme's text color for bundle label
                const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
                const firstTheme = bundleMap[bundle][0];
                const bundleLabel = document.createElement('div');
                bundleLabel.textContent = bundle;
                bundleLabel.className = 'bundle-label';
                bundleLabel.style.color = themeObj.text;
                bundleLabel.style.fontWeight = 'bold';
                bundleLabel.style.fontSize = '1.1em';
                bundleLabel.style.marginBottom = '8px';
                col.appendChild(bundleLabel);
                bundleMap[bundle].forEach(theme => {
                    const btn = document.createElement('button');
                    btn.textContent = `${theme.name} - ${theme.price} coins`;
                    btn.className = 'themeBtn shopBtn';
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                    btn.style.marginBottom = '8px';
                    btn.onclick = function() {
                        if (coins >= theme.price) {
                            subtractCoins(theme.price);
                            ownedThemes.push(theme.name);
                            localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
                            renderShop();
                            renderInventory();
                        } else {
                            showCustomAlert("Not enough coins!", "error");
                        }
                    };
                    col.appendChild(btn);
                });
                bundlesRow.appendChild(col);
            });
            shopDiv.appendChild(bundlesRow);
            if (shopDiv.innerHTML === '') {
                shopDiv.innerHTML = '<p style="text-align:center; color:#888;">All themes owned!</p>';
            }
        }

        function renderInventory() {
            const invDiv = document.getElementById('inventoryThemes');
            invDiv.innerHTML = '';
            // Group owned themes by bundle
            const bundleMap = {};
            ownedThemes.forEach(themeName => {
                const theme = themes.find(t => t.name === themeName);
                const bundle = theme.bundle || 'Other';
                if (!bundleMap[bundle]) bundleMap[bundle] = [];
                bundleMap[bundle].push(theme);
            });
            invDiv.innerHTML = '';
            const bundleNames = Object.keys(bundleMap);
            bundleNames.forEach(bundle => {
                const col = document.createElement('div');
                col.style.display = 'flex';
                col.style.flexWrap = 'wrap';
             
                col.style.alignItems = 'center';
                col.style.minWidth = '180px';
                col.style.marginBottom = '12px';
                // Use first theme's text color for bundle label
                const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
                const firstTheme = bundleMap[bundle][0];
                const bundleLabel = document.createElement('div');
                bundleLabel.textContent = bundle;
                bundleLabel.className = 'bundle-label';
                bundleLabel.style.color = themeObj.text;
                bundleLabel.style.fontWeight = 'bold';
                bundleLabel.style.fontSize = '1.1em';
                bundleLabel.style.marginBottom = '8px';
                col.appendChild(bundleLabel);
                bundleMap[bundle].forEach(theme => {
                    const btn = document.createElement('button');
                    btn.textContent = theme.name;
                    btn.className = 'themeBtn owned' + (selectedTheme === theme.name ? ' selected' : '');
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                    btn.style.marginBottom = '8px';
                    btn.onclick = function() {
                        selectTheme(theme.name);
                    };
                    col.appendChild(btn);
                });
                invDiv.appendChild(col);
            });
        }

        function selectTheme(themeName) {
          
            selectedTheme = themeName;
            const theme = themes.find(t => t.name === themeName);
          //      const fontstyle = choosentheme.FS || "";

          //Update top bar
          document.querySelector('meta[name="theme-color"]').setAttribute('content', theme.Tb);
          //Update head

            document.body.style.background = theme.bg;
            document.querySelector('.container').style.background = theme.bg;
            document.getElementById('mainTitle').style.color = theme.title || theme.text;
               document.getElementById('CounterTitle').style.color = theme.title || theme.text;
            document.getElementById('shopTitle').style.color = theme.title || theme.text;
            document.getElementById('settingsTitle').style.color = theme.title || theme.text;
            document.querySelector('.container').style.color = theme.text;

       
        
            // Update only inventory themeBtn buttons (not shopBtn)
            document.querySelectorAll('.themeBtn').forEach(btn => {
                if (!btn.classList.contains('shopBtn')) {
                    btn.style.background = theme.btn;
                    btn.style.color = theme.text;
                }
            });
            // Update bundle label colors in inventory columns
            document.querySelectorAll('.bundle-label').forEach(label => {
                label.style.color = theme.text;
            });

            // Update control buttons (Start, Pause, Reset)
            document.getElementById('startBtn').style.background = theme.btn;
            document.getElementById('startBtn').style.color = theme.text;
            document.getElementById('pauseBtn').style.background = theme.btn;
            document.getElementById('pauseBtn').style.color = theme.text;
            document.getElementById('resetBtn').style.background = theme.btn;
            document.getElementById('resetBtn').style.color = theme.text;
            // Update tab buttons
            document.getElementById('pomodoroTabBtn').style.background = theme.btn;
            document.getElementById('pomodoroTabBtn').style.color = theme.text;
            document.getElementById('shopTabBtn').style.background = theme.btn;
            document.getElementById('shopTabBtn').style.color = theme.text;
            document.getElementById('settingsTabBtn').style.background = theme.btn;
            document.getElementById('settingsTabBtn').style.color = theme.text;
            document.getElementById('todoTabBtn').style.background = theme.btn;
            document.getElementById('todoTabBtn').style.color = theme.text;
            // Style settings wipe button
            if (document.getElementById('deleteDataBtn')) {
                document.getElementById('deleteDataBtn').style.background = theme.btn;
                document.getElementById('deleteDataBtn').style.color = theme.text;
            }
            // Style progress bar
            if (document.getElementById('progressBar')) {
                document.getElementById('progressBar').style.background = theme.btn;
            }
            // Style To Do List tab: week day containers and activities
            for (let i = 0; i < 7; i++) {
                // Day container background and text
                const dayContainer = document.getElementById('todoDay' + i);
                if (dayContainer) {
                    dayContainer.style.background = theme.Tb;
                    dayContainer.style.color = theme.text;
                }
                // Day title
                const dayTitle = dayContainer ? dayContainer.querySelector('h3') : null;
                if (dayTitle) {
                    dayTitle.style.color = theme.text;
                }
                // Completion estimate
                const estimate = document.getElementById('completionEstimate' + i);
                if (estimate) {
                    estimate.style.color = theme.text;
                }
                // Add Activity button
                const addBtn = document.getElementById('addActivityBtn' + i);
                if (addBtn) {
                    addBtn.style.background = theme.btn;
                    addBtn.style.color = theme.text;
                }
                // Activities
                const activityList = document.getElementById('activityList' + i);
                if (activityList) {
                    activityList.querySelectorAll('.activity').forEach(div => {
                        div.style.background = theme.bg;
                        div.style.color = theme.text;
                    });
                    activityList.querySelectorAll('.activityCompleteBtn').forEach(btn => {
                        btn.style.background = theme.btn;
                        btn.style.color = theme.text;
                    });
                }
            }
            // Modal buttons
            document.getElementById('confirmActivityBtn').style.background = theme.btn;
            document.getElementById('confirmActivityBtn').style.color = theme.text;
            document.getElementById('cancelActivityBtn').style.background = theme.btn;
            document.getElementById('cancelActivityBtn').style.color = theme.text;
            // Top bar and app title
            document.getElementById('topBar').style.background = theme.Tb;
            document.getElementById('AppTitle').style.color = theme.text;
            renderInventory();
        }

        // Initial render
        // Load coins, inventory, and goal from localStorage and reset if needed
        function loadAllData() {
            const saved = localStorage.getItem('pomodoroCoins');
            const lastReset = localStorage.getItem('pomodoroLastReset');
            const today = getTodayString();
            const hour = getCurrentHour();
            // Load inventory
            const inv = localStorage.getItem('pomodoroInventory');
            ownedThemes = inv ? JSON.parse(inv) : ["Classic"];
            // Load goal
            const savedGoal = localStorage.getItem('pomodoroGoal');
            goal = savedGoal ? parseInt(savedGoal) : 100;
            document.getElementById('goalInput').value = goal;
            // Only reset coins and inventory at 01:00 on Sundays
            if (isSunday() && lastReset !== today && hour >= 1) {
                coins = 0;
                ownedThemes = ["Classic"];
                localStorage.setItem('pomodoroCoins', coins);
                localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
                localStorage.setItem('pomodoroLastReset', today);


            } else {
                coins = saved ? parseInt(saved) : 0;
            }
        }

        loadAllData();
        updateTimerDisplay();
        updateCoinsDisplay();
        renderShop();
        renderInventory();
        selectTheme(selectedTheme);
          updateProgressBar();

        // Settings logic
        if (document.getElementById('deleteDataBtn')) {
            document.getElementById('deleteDataBtn').addEventListener('click', function() {

                const result = confirm('Are you sure you want to delete all coin and inventory data? This cannot be undone.');
               if (!result) return;
                coins = 0;
                ownedThemes = ["Classic","Night"];
                localStorage.setItem('pomodoroCoins', coins);
                localStorage.setItem('pomodoroInventory', JSON.stringify(ownedThemes));
                updateCoinsDisplay();
                renderInventory();
                updateProgressBar();
                
  showCustomAlert("Coin and inventory data deleted!", "success");
    selectTheme("Classic");
  
                renderShop(); // Fix: reload shop after data deletion
          

            });
        }
        // Goal input change
        if (document.getElementById('goalInput')) {
            document.getElementById('goalInput').addEventListener('change', function() {
                goal = parseInt(this.value) || 1;
                localStorage.setItem('pomodoroGoal', goal);
                updateProgressBar();
                showCustomAlert(`Goal set to ${goal} coins!`, "info");
            });
        }

        // To Do List logic
// --- 7 separate To Do List containers for each day ---
const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
let weekActivities = Array(7).fill().map(() => []);

function loadWeekActivities() {
  daysOfWeek.forEach((day, i) => {
    const saved = localStorage.getItem('pomodoroActivities_' + day);
    weekActivities[i] = saved ? JSON.parse(saved) : [];
    calculateCompletionTimeEstimate(i);
  });
}
function saveWeekActivities(dayIdx) {
  localStorage.setItem('pomodoroActivities_' + daysOfWeek[dayIdx], JSON.stringify(weekActivities[dayIdx]));
}
function renderWeekActivities(dayIdx) {
  const list = document.getElementById('activityList' + dayIdx);
  list.innerHTML = '';
  const activities = weekActivities[dayIdx];
  if (activities.length === 0) {
    list.innerHTML = '<p style="color:#888; text-align:center;">No activities yet.</p>';
    return;
  }
  const themeObj = themes.find(t => t.name === selectedTheme) || themes[0];
  // themeObj is the activity background, not the main theme background
  activities.forEach((act, idx) => {
    const div = document.createElement('div');
    div.className = 'activity';
    div.style.display = 'flex';
    div.style.flexDirection = 'column';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    // Set background color to theme.bg (not themeObj.background)
    div.style.background = themeObj.bg;
    
    div.style.borderRadius = '6px';
    div.style.margin = '8px 0';
    div.style.padding = '8px 12px';
    div.innerHTML = `<span>${act.name} (${act.price} coins)</span>`;
    const btn = document.createElement('button');
    btn.textContent = 'Complete';
    btn.className = 'settingsBtn activityCompleteBtn';
    btn.style.background = themeObj.btn;
    btn.style.color = themeObj.text;
    btn.onclick = function() {
      if (coins >= act.price) {
        subtractCoins(act.price);
        activities.splice(idx, 1);
        saveWeekActivities(dayIdx);
        renderWeekActivities(dayIdx);
        showCustomAlert(`Completed: ${act.name}`, "success");
        calculateCompletionTimeEstimate(dayIdx);
        setTimeout(() => {
          document.querySelectorAll(`#activityList${dayIdx} .activityCompleteBtn`).forEach(btn => {
            btn.style.background = themeObj.btn;
            btn.style.color = themeObj.text;
          });
        }, 0);
      } else {
        showCustomAlert("Not enough coins!", "error");
      }
    };

    div.appendChild(btn);
    list.appendChild(div);
  });
}
function calculateCompletionTimeEstimate(dayIdx) {
  const activities = weekActivities[dayIdx];
  const totalTaskCoins = activities.reduce((sum, task) => sum + task.price, 0);
  const netCoinsNeeded = totalTaskCoins - coins;
  const estimateElement = document.getElementById('completionEstimate' + dayIdx);
  if (totalTaskCoins === 0) {
    estimateElement.textContent = "No tasks available.";
    return;
  }
  if (netCoinsNeeded <= 0) {
    estimateElement.textContent = "All tasks can be completed with current coins!";
    return;
  }
  const now = new Date();
  const finishTime = new Date(now.getTime() + netCoinsNeeded * 60000);
  const hours = finishTime.getHours().toString().padStart(2, '0');
  const minutes = finishTime.getMinutes().toString().padStart(2, '0');
  const timeString = `${hours}:${minutes}`;
  estimateElement.textContent = `Estimated finish time: ${timeString} / ${netCoinsNeeded} more coins needed/ ${totalTaskCoins} total task coins`;
}
// Modal logic
const modal = document.getElementById('activityModal');
let currentDayIdx = 0;
function setupAddActivityButtons() {
  daysOfWeek.forEach((day, i) => {
    const btn = document.getElementById('addActivityBtn' + i);
    if (btn) {
      btn.onclick = function() {
        currentDayIdx = i;
        modal.style.display = 'flex';
        document.getElementById('activityNameInput').value = '';
        document.getElementById('activityPriceInput').value = 10;
      };
    }
  });
}
setupAddActivityButtons();
document.getElementById('cancelActivityBtn').onclick = function() {
  modal.style.display = 'none';
};
document.getElementById('confirmActivityBtn').onclick = function() {
  const name = document.getElementById('activityNameInput').value.trim();
  const price = parseInt(document.getElementById('activityPriceInput').value);
  if (!name || !price || price < 1) {
    alert('Please enter a valid name and coin price.');
    return;
  }
  weekActivities[currentDayIdx].push({ name, price });
  saveWeekActivities(currentDayIdx);
  renderWeekActivities(currentDayIdx);
  modal.style.display = 'none';
  calculateCompletionTimeEstimate(currentDayIdx);
};
// Initial render for all days
loadWeekActivities();
daysOfWeek.forEach((day, i) => {
  renderWeekActivities(i);
});
    </script>
</body>
</html>
